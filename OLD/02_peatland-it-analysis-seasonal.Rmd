---
title: "Transfer Entrop Flow Analysis"
author: "Mariel Jones"
date: "2024-08-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
fig_save = "./Figures/"
load_path = "./mef-data/"
```

```{r}
library(astsa)
library(dplyr)
library(xts)
library(lubridate)
library(RTransferEntropy)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(forecastML)
library(cowplot)
library(reshape2)
library(zoo)
library(infotheo)
library(stringr)
library(latex2exp)
library(Hmisc)
```

### Data Import from EDI

```{r, echo = False}
## Precipitation
precipURL  <- "https://pasta.lternet.edu/package/data/eml/edi/849/5/4f7e0b3029833c26d64fda3d23037d1d" 
precipInfile <- tempfile()
try(download.file(precipURL,precipInfile,method="curl"))
if (is.na(file.size(precipInfile))) download.file(precipURL,precipInfile,method="auto")

precip <-read.csv(precipInfile , header=F, skip=1, sep = ",", 
               col.names=c("TIMESTAMP", "South_PCP", "South_Flag"),check.names=TRUE)
               
unlink(precipInfile)
tmp3TIMESTAMP<-as.POSIXct(precip$TIMESTAMP,format="%Y-%m-%d %H:%M:%S")
# Keep the new dates only if they all converted correctly
if(nrow(precip[precip$TIMESTAMP != "",]) == length(tmp3TIMESTAMP[!is.na(tmp3TIMESTAMP)])){precip$TIMESTAMP <- tmp3TIMESTAMP } else {print("Date conversion failed for precip$TIMESTAMP. Please inspect the data and do the date conversion yourself.")}                                 
if (class(precip$South_PCP)=="factor") precip$South_PCP <-as.numeric(levels(precip$South_PCP))[as.integer(precip$South_PCP) ]               
if (class(precip$South_PCP)=="character") precip$South_PCP <-as.numeric(precip$South_PCP)
if (class(precip$South_Flag)!="factor") precip$South_Flag<- as.factor(precip$South_Flag)
                
# Convert Missing Values to NA for non-dates
precip$South_PCP <- ifelse((trimws(as.character(precip$South_PCP))==trimws("NA")),NA,precip$South_PCP)         
## 10 minute soil moisture
smURL  <- "https://pasta.lternet.edu/package/data/eml/edi/989/3/e25d4f15276a3158af412758502a59b0" 
smInfile <- tempfile()
try(download.file(smURL,smInfile,method="curl"))
if (is.na(file.size(smInfile))) download.file(smURL,smInfile,method="auto")

sm <-read.csv(smInfile, header=F, skip=1, sep=",", 
              col.names=c("TIMESTAMP", "S2S_UP_SH", "S2S_UP_DP", "S2S_MI_SH", 
                          "S2S_MI_DP", "S2S_LO_SH", "S2S_LO_DP", "S2N_UP_SH",     
                          "S2N_UP_DP", "S2N_MI_SH", "S2N_MI_DP", "S2N_LO_SH",     
                          "S2N_LO_DP"), check.names=TRUE)
               
unlink(smInfile)
tmp2TIMESTAMP<-as.POSIXct(sm$TIMESTAMP,format="%Y-%m-%d %H:%M:%S")
# Keep the new dates only if they all converted correctly
if(nrow(sm[sm$TIMESTAMP != "",]) == length(tmp2TIMESTAMP[!is.na(tmp2TIMESTAMP)])){sm$TIMESTAMP <- tmp2TIMESTAMP } else {print("Date conversion failed for sm$TIMESTAMP. Please inspect the data and do the date conversion yourself.")}    

                                
## Bog well WTE
bogURL  <- "https://pasta.lternet.edu/package/data/eml/edi/562/3/671f15337a677da71852de506a8d9b05" 
bogInfile <- tempfile()
try(download.file(bogURL,bogInfile,method="curl"))
if (is.na(file.size(bogInfile))) download.file(bogURL,bogInfile,method="auto")

bog <-read.csv(bogInfile, header=F,skip=1, sep=",",
               col.names=c("PEATLAND", "DATE", "WTE", "FLAG"), check.names=TRUE)
               
unlink(bogInfile)
if (class(bog$PEATLAND)!="factor") bog$PEATLAND<- as.factor(bog$PEATLAND)                                   
tmp1DATE<-as.Date(bog$DATE,format="%Y-%m-%d")
# Keep the new dates only if they all converted correctly
if(nrow(bog[bog$DATE != "",]) == length(tmp1DATE[!is.na(tmp1DATE)])){bog$DATE <- tmp1DATE } else {print("Date conversion failed for bog$DATE. Please inspect the data and do the date conversion yourself.")}
if (class(bog$WTE)=="factor") bog$WTE <-as.numeric(levels(bog$WTE))[as.integer(bog$WTE) ]               
if (class(bog$WTE)=="character") bog$WTE <-as.numeric(bog$WTE)
if (class(bog$FLAG)!="factor") bog$FLAG<- as.factor(bog$FLAG)
                
# Convert Missing Values to NA for non-dates
bog$WTE <- ifelse((trimws(as.character(bog$WTE))==trimws("NA")),NA,bog$WTE)  

# Select just the S2 watershed
bog = bog %>%
  filter(PEATLAND == 'S2')



## Lagg transition well WTE
laggwellURL  <- "https://pasta.lternet.edu/package/data/eml/edi/1126/1/2532f551e6e5a97aee8f140fb5da8a74" 
laggwellInfile <- tempfile()
try(download.file(laggwellURL,laggwellInfile,method="curl"))
if (is.na(file.size(laggwellInfile))) download.file(laggwellURL,laggwellInfile,method="auto")

laggwell <-read.csv(laggwellInfile, header=F, skip=1, sep=",", quot='"' ,
                    col.names=c("DateTime", "LoggerLevel", "LoggerTemp", "BP",     
                                "Precip", "bogwell", "well_elev", "well_name",     
                                "watershed", "year"), check.names=TRUE)
               
unlink(laggwellInfile)
              
tmp1DateTime<-as.POSIXct(laggwell$DateTime,format="%Y-%m-%d %H:%M:%S" )
# Keep the new dates only if they all converted correctly
if(nrow(laggwell[laggwell$DateTime != "",]) == length(tmp1DateTime[!is.na(tmp1DateTime)])){laggwell$DateTime <- tmp1DateTime } else {print("Date conversion failed for laggwell$DateTime. Please inspect the data and do the date conversion yourself.")}


                                
## Streamflow
streamURL  <- "https://pasta.lternet.edu/package/data/eml/edi/573/1/2aca4b900546e80ed7dd409ff1ad9787" 
streamInfile <- tempfile()
try(download.file(streamURL,streamInfile,method="curl"))
if (is.na(file.size(streamInfile))) download.file(streamURL,streamInfile,method="auto")

stream <-read.csv(streamInfile, header=F, skip=1, sep=",",
                  col.names=c("Peatland", "DateTime", "Stage.ft", "Q.cfs", "q.mmh", "q.interval"),
                  check.names=TRUE)
               
unlink(streamInfile)
if (class(stream$Peatland)!="factor") stream$Peatland<- as.factor(stream$Peatland)                       
tmp1DateTime<-as.POSIXct(stream$DateTime,format="%Y-%m-%d %H:%M:%S")
# Keep the new dates only if they all converted correctly
if(nrow(stream[stream$DateTime != "",]) == length(tmp1DateTime[!is.na(tmp1DateTime)])){stream$DateTime <- tmp1DateTime } else {print("Date conversion failed for stream$DateTime. Please inspect the data and do the date conversion yourself.")} 


## General Met Station Data
metURL  <- "https://pasta.lternet.edu/package/data/eml/edi/859/4/e1e7792f8465017e133535bccbba4b6c" 
metInfile <- tempfile()
try(download.file(metURL,metInfile,method="curl"))
if (is.na(file.size(metInfile))) download.file(metURL,metInfile,method="auto")
met <-read.csv(metInfile, header=F, skip=1, sep=",", 
               col.names=c("TIMESTAMP", "Air_TempC_Avg", "RH",     
                    "Soil_TempC_Avg", "WS_Tot", "WindDir_D",     
                    "WindDir_SD", "PAR_Den_Avg", "Soil_VWC_Avg"),
               check.names=TRUE)
unlink(metInfile)                      
tmp1DateTime<-as.POSIXct(met$TIMESTAMP,format="%Y-%m-%d %H:%M:%S")
# Keep the new dates only if they all converted correctly
if(nrow(met[met$TIMESTAMP != "",]) == length(tmp1DateTime[!is.na(tmp1DateTime)])){met$TIMESTAMP <- tmp1DateTime } else {print("Date conversion failed for stream$DateTime. Please inspect the data and do the date conversion yourself.")} 

## Air Temp
tempURL  <- "https://pasta.lternet.edu/package/data/eml/edi/583/4/982d194dd32adb4419b14e936056c26c" 
tempInfile <- tempfile()
try(download.file(tempURL,tempInfile,method="curl"))
if (is.na(file.size(tempInfile))) download.file(tempURL,tempInfile,method="auto")
temp <-read.csv(tempInfile, header=F, skip=1, sep=",",  
                col.names=c("Date", "STATION", "MAXC",
                            "MINC", "FLAG"),
                check.names=TRUE)
unlink(tempInfile)
tmp1Date<-as.Date(temp$Date,format="%Y-%m-%d")
# Keep the new dates only if they all converted correctly
if(nrow(temp[temp$Date != "",]) == length(tmp1Date[!is.na(tmp1Date)])){temp$Date <- tmp1Date } else {print("Date conversion failed for temp$Date. Please inspect the data and do the date conversion yourself.")}                                                                    
```

Data is then aggregated to daily timescales

```{r}
#Data sets: stream (1962-2017), sm (2008-2023), precip (2011-2024), laggwell (2018-2020), bog (1961-2023), met (2008-2024), temp (1961-2024)

#Resample precip to daily timestep
#round dates down to week
precip$day <- floor_date(precip$TIMESTAMP, "day")

precip_daily = data.frame(precip %>%
  group_by(day) %>%
  summarize(South_PCP = sum(South_PCP)))
```

```{r}
#Resample well data to daily timestep
#round dates down to week
laggwell$day <- floor_date(laggwell$DateTime, "day")

laggwell_daily = data.frame(laggwell) %>%
  group_by(day, well_name) %>%
  summarize(well_elev = mean(well_elev))
```

```{r}
#Resample temperature to daily timestep
#round dates down to week
met$day <- floor_date(met$TIMESTAMP, "day")

met_daily = data.frame(met) %>%
  group_by(day) %>%
  summarise_all(mean)
```

```{r}
#Resample temperature to daily timestep
#round dates down to week
temp$day <- floor_date(temp$Date, "day")

temp_daily = data.frame(temp) %>%
  filter(STATION == 'S2Bog') %>%
  mutate(MEANC = 0.5*(MAXC + MINC))
```

```{r}
#Melt the lagg data so there is a column per well
laggwell_melt = laggwell_daily %>%
  pivot_wider(names_from = 'well_name', values_from = 'well_elev')
```

```{r}
#Resample soil moisture to daily timestep
#round dates down to week
sm$day <- floor_date(sm$TIMESTAMP, "day")

sm_daily = data.frame(sm) %>%
  group_by(day) %>%
  summarise_all(mean) %>%
  select(-TIMESTAMP)
```

```{r}
#Resample streamflow to daily timestep
#round dates down to week
stream$day <- floor_date(stream$DateTime, "day")

stream_daily = data.frame(stream) %>%
  group_by(day) %>%
  summarize(qInterval = mean(q.interval)/10)
```

Merge data into one data frame for IT analysis

```{r}
#Merge into a dataframe by date and clip to full series
dat = merge(x = precip_daily, y = bog, by.x = "day", by.y = "DATE", all = TRUE)
dat = merge(dat, laggwell_melt, by = 'day', all = TRUE)
dat = merge(dat, sm_daily, by = 'day', how = 'outer', all = TRUE)
dat = merge(dat, stream_daily, by = 'day', how = 'outer', all = TRUE)
dat = merge(dat, met_daily, by = 'day', how = 'outer', all = TRUE)
dat = merge(dat, temp_daily, by = 'day', how = 'outer', all = TRUE)

head(dat)
```

We are now ready for gap filling and data analysis.

## Initial Plotting

```{r}
#Initial timeseries plots

#Precip
ggplot(data = dat, aes(x = day, y = South_PCP)) +
  geom_point(color = 'gray') +
  geom_line() +
  xlab('Date') + 
  ylab('Precipitation [cm]') + 
  theme(aspect.ratio = 0.3, 
        panel.background = element_blank())

#Bog WTE
ggplot(data = dat, aes(x = day, y = WTE)) + 
  geom_point(color = 'gray') + 
  geom_line() + 
  xlab('Date') + 
  ylab('Bog Water Table Elevation [m]') +
  theme(aspect.ratio = 0.3, 
        panel.background = element_blank())

#LAGG WTE
ggplot(data = dat) +
  geom_line(aes(x = day, y = KF42W), color = 'darkolivegreen1') + 
  geom_line(aes(x = day, y = KF43W), color = 'cadetblue1') + 
  geom_line(aes(x = day, y = KF45W), color = 'brown1') +
  geom_line(aes(x = day, y = S2S1), color = 'darkolivegreen') + 
  geom_line(aes(x = day, y = S2S2), color = 'cadetblue3') + 
  geom_line(aes(x = day, y = S2S3), color = 'brown') +
  xlab('Date') +
  ylab('Lagg Water Table Elevation [m]') + 
  theme(legend.position = 'none', 
        aspect.ratio = 0.3, 
        panel.background = element_blank())

#SOIL 
ggplot(data = dat) +
  geom_line(aes(x = day, y = S2S_UP_SH), color = 'darkolivegreen1') + 
  geom_line(aes(x = day, y = S2S_UP_DP), color = 'darkolivegreen1', linetype = 2) + 
  geom_line(aes(x = day, y = S2S_MI_SH), color = 'darkolivegreen3') +
  geom_line(aes(x = day, y = S2S_MI_DP), color = 'darkolivegreen3', linetype = 2) + 
  geom_line(aes(x = day, y = S2S_LO_SH), color = 'darkolivegreen') + 
  geom_line(aes(x = day, y = S2S_LO_DP), color = 'darkolivegreen', linetype = 2) +
  geom_line(aes(x = day, y = S2N_UP_SH), color = 'darkslategray1') + 
  geom_line(aes(x = day, y = S2N_UP_DP), color = 'darkslategray1', linetype = 2) + 
  geom_line(aes(x = day, y = S2N_MI_SH), color = 'darkslategray3') +
  geom_line(aes(x = day, y = S2N_MI_DP), color = 'darkslategray3', linetype = 2) + 
  geom_line(aes(x = day, y = S2N_LO_SH), color = 'darkslategray') + 
  geom_line(aes(x = day, y = S2N_LO_DP), color = 'darkslategray', linetype = 2) +
  xlab('Date') +
  ylab('Soil Moisture [m3/m3]') +
  theme(legend.position = 'none', 
        aspect.ratio = 0.3, 
        panel.background = element_blank()) 

#Streamflow
ggplot(data = dat, aes(x = day, y = qInterval)) +
  geom_point(color = 'gray') + 
  geom_line() + 
  xlab('Date') + 
  ylab('Streamflow [cm]') + 
  theme(aspect.ratio = 0.3,
        panel.background = element_blank())

#Air Temperature
ggplot(data = dat, aes(x = day, y = MEANC)) +
  geom_point(color = 'gray') + 
  geom_line() + 
  xlab('Date') + 
  ylab('Mean Daily Temperature [C]') + 
  theme(aspect.ratio = 0.3,
        panel.background = element_blank())

```

## Clip to timescales for IT analysis

Leaving out the lagg water table levels, clip the data to the longest time length possible (~2012 - 2022)

```{r}
data_clipped = dat %>%
  select(-c('KF42W', 'KF43W', 'KF45W', 'S2S1', 'S2S2', 'S2S3', 'S6S1', 'S6S2', 'S6S3', 'S6N1', 'S6N2', 'S6N3'))

head(data_clipped)
```


```{r}
data = merge(data_clipped,
             data.frame(times = floor_date(seq(from = as.POSIXct('2011-02-03'), to = as.POSIXct('2017-02-28'), by = "day"), 'day')), 
             by.x = 'day', by.y = 'times', 
             all.y = TRUE)
```

```{r}

#Precip
ggplot(data = data, aes(x = day, y = South_PCP)) +
  geom_point(color = 'gray') +
  geom_line() +
  xlab('Date') + 
  ylab('Precipitation [cm]') + 
  theme(aspect.ratio = 0.3, 
        panel.background = element_blank())

#Bog WTE
ggplot(data = data, aes(x = day, y = WTE)) + 
  geom_point(color = 'gray') + 
  geom_line() + 
  xlab('Date') + 
  ylab('Bog Water Table Elevation [m]') +
  theme(aspect.ratio = 0.3, 
        panel.background = element_blank())


#SOIL 
ggplot(data = data) +
  geom_line(aes(x = day, y = S2S_UP_SH), color = 'darkolivegreen1') + 
  geom_line(aes(x = day, y = S2S_UP_DP), color = 'darkolivegreen1', linetype = 2) + 
  geom_line(aes(x = day, y = S2S_MI_SH), color = 'darkolivegreen3') +
  geom_line(aes(x = day, y = S2S_MI_DP), color = 'darkolivegreen3', linetype = 2) + 
  geom_line(aes(x = day, y = S2S_LO_SH), color = 'darkolivegreen') + 
  geom_line(aes(x = day, y = S2S_LO_DP), color = 'darkolivegreen', linetype = 2) +
  geom_line(aes(x = day, y = S2N_UP_SH), color = 'darkslategray1') + 
  geom_line(aes(x = day, y = S2N_UP_DP), color = 'darkslategray1', linetype = 2) + 
  geom_line(aes(x = day, y = S2N_MI_SH), color = 'darkslategray3') +
  geom_line(aes(x = day, y = S2N_MI_DP), color = 'darkslategray3', linetype = 2) + 
  geom_line(aes(x = day, y = S2N_LO_SH), color = 'darkslategray') + 
  geom_line(aes(x = day, y = S2N_LO_DP), color = 'darkslategray', linetype = 2) +
  xlab('Date') +
  ylab('Soil Moisture [m3/m3]') +
  theme(legend.position = 'none', 
        aspect.ratio = 0.3, 
        panel.background = element_blank()) 

#Streamflow
ggplot(data = data, aes(x = day, y = qInterval)) +
  geom_point(color = 'gray') + 
  geom_line() + 
  xlab('Date') + 
  ylab('Streamflow [cm]') + 
  theme(aspect.ratio = 0.3,
        panel.background = element_blank())

#Temperature
ggplot(data = data, aes(x = day, y = MEANC)) + 
  geom_point(color = 'gray') + 
  geom_line() + 
  xlab('Date') + 
  ylab('Air Temperature, [C]') + 
  theme(aspect.ratio = 0.3, 
        panel.background = element_blank())
```

## Aggregate to Monthly timescales

```{r}
#round dates down to week
data$month <- floor_date(data$day, "month")

#group by and summarize
data_means = data %>%
   group_by(month) %>%
   select(c(month, South_PCP, WTE, qInterval, MEANC)) %>%
   summarize_all(mean, na.rm = TRUE) %>%
   rename(meanPrecip = South_PCP, meanWTE = WTE, meanQ = qInterval, meanT = MEANC)

data_totals = data %>%
   group_by(month) %>%
   select(c(month, South_PCP, qInterval)) %>%
   summarize_all(sum, na.rm = TRUE) %>%
   rename(totPrecip = South_PCP, totQ = qInterval)

#Currently grouping all soil data into north and south, deep and shallow resevoirs but will come back and separate these out later
data_soils = data %>%
  mutate(S2S_SH = rowMeans(select(data, c(S2S_UP_SH, S2S_MI_SH, S2S_LO_SH)), na.rm = TRUE)) %>%
  mutate(S2S_DP = rowMeans(select(data, c(S2S_UP_DP, S2S_MI_DP, S2S_LO_DP)), na.rm = TRUE)) %>%
  mutate(S2N_SH = rowMeans(select(data, c(S2N_UP_SH, S2N_MI_SH, S2N_LO_SH)), na.rm = TRUE)) %>%
  mutate(S2N_DP = rowMeans(select(data, c(S2N_UP_DP, S2N_MI_DP, S2N_LO_DP)), na.rm = TRUE)) %>%
  group_by(month) %>%
  select(c(month, S2S_SH, S2S_DP, S2N_SH, S2N_DP)) %>%
  summarize_all(mean, na.rm = TRUE)
```

```{r}
#Merge all data together
data_monthly = merge(data_means, data_totals, by = 'month')
data_monthly = merge(data_monthly, data_soils, by = 'month')
summary(data_monthly)
```

## Monthly plots

```{r}
#Precip
p1 = ggplot(data = data_monthly) +
  geom_point(aes(x = month, y = meanPrecip, color = 'mean Precip')) +
  geom_line(aes(x = month, y = meanPrecip, color = 'mean Precip')) +
  geom_point(aes(x = month, y = totPrecip, color = 'total Precip')) +
  geom_line(aes(x = month, y = totPrecip, color = 'total Precip')) +
  geom_point(aes(x = month, y = meanT, color = 'mean Temp')) +
  geom_line(aes(x = month, y = meanT, color = 'mean Temp')) +
  xlab('Date') + 
  ylab('Precipitation [cm]') + 
  scale_color_manual(" ", values = c('gray', 'black', 'darkred')) + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

#Bog WTE
b1 = ggplot(data = data_monthly, aes(x = month, y = meanWTE)) + 
  geom_point(color = 'gray') + 
  geom_line(color = 'gray') + 
  xlab('Date') + 
  ylab('Bog WTE [m]') +
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())


#SOIL 
s1 = ggplot(data = data_monthly) +
  geom_line(aes(x = month, y = S2S_SH, color = 'S2S SH')) +
  geom_line(aes(x = month, y = S2S_DP, color = 'S2S DP'), linetype = 3) + 
  geom_line(aes(x = month, y = S2N_SH, color = 'S2N SH')) +
  geom_line(aes(x = month, y = S2N_DP, color = 'S2N DP'), linetype = 3) + 
  geom_point(aes(x = month, y = S2S_SH, color = 'S2S SH')) +
  geom_point(aes(x = month, y = S2S_DP, color = 'S2S DP')) + 
  geom_point(aes(x = month, y = S2N_SH, color = 'S2N SH')) +
  geom_point(aes(x = month, y = S2N_DP, color = 'S2N DP')) + 
  xlab('Date') +
  ylab('Soil Moisture [m3/m3]') +
  scale_color_manual(" ", values =  c("darkolivegreen3", "darkolivegreen3", "royalblue", "royalblue")) + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank()) 

#Streamflow
q1 = ggplot(data = data_monthly) +
  geom_point(aes(x = month, y = meanQ, color = 'mean Q')) +
  geom_line(aes(x = month, y = meanQ, color = 'mean Q')) +
  geom_point(aes(x = month, y = totQ, color = 'total Q')) +
  geom_line(aes(x = month, y = totQ, color = 'total Q')) +
  xlab('Date') + 
  ylab('Streamflow [cm]') + 
  scale_color_manual(" ", values = c('gray', 'black')) +
  theme(legend.position = 'top',
        aspect.ratio = 0.3,
        panel.background = element_blank())

timeseries = plot_grid(p1, b1, s1, q1,
          labels = c('A', 'B', 'C', 'D'),
          label_size = 12,
          align="hv")

save_plot(paste0(fig_save, 'monthlydata_timeseries.pdf'), timeseries, base_height = 5)
save_plot(paste0(fig_save, 'monthlydata_timeseries.jpeg'), timeseries, base_height = 5)
timeseries

```

## Gap filling of soil moisture data
Just a linear gap fill for now because the gaps are no longer than 2 to 3 months. For the daily analysis we may need to come up with a better method.

```{r}
data_monthly_nogaps = data_monthly %>%
  mutate(S2S_DP = na.approx(S2S_DP)) %>%
  mutate(S2S_SH = na.approx(S2S_SH)) %>%
  mutate(S2N_DP = na.approx(S2N_DP)) %>%
  mutate(S2N_SH = na.approx(S2N_SH))%>%
  mutate(meanT = na.approx(meanT))

summary(data_monthly_nogaps)
```

```{r}
ggplot(data = data_monthly_nogaps) +
  geom_line(aes(x = month, y = S2S_SH, color = 'S2S SH')) +
  geom_line(aes(x = month, y = S2S_DP, color = 'S2S DP'), linetype = 3) + 
  geom_line(aes(x = month, y = S2N_SH, color = 'S2N SH')) +
  geom_line(aes(x = month, y = S2N_DP, color = 'S2N DP'), linetype = 3) + 
  geom_point(aes(x = month, y = S2S_SH, color = 'S2S SH')) +
  geom_point(aes(x = month, y = S2S_DP, color = 'S2S DP')) + 
  geom_point(aes(x = month, y = S2N_SH, color = 'S2N SH')) +
  geom_point(aes(x = month, y = S2N_DP, color = 'S2N DP')) + 
  xlab('Date') +
  ylab('Soil Moisture [m3/m3]') +
  scale_color_manual(" ", values =  c("darkolivegreen3", "darkolivegreen3", "royalblue", "royalblue")) + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank()) 
```

```{r}
ggplot(data = data_monthly_nogaps) +
  geom_point(aes(x = month, y = meanPrecip, color = 'mean Precip')) +
  geom_line(aes(x = month, y = meanPrecip, color = 'mean Precip')) +
  geom_point(aes(x = month, y = totPrecip, color = 'total Precip')) +
  geom_line(aes(x = month, y = totPrecip, color = 'total Precip')) +
  geom_point(aes(x = month, y = meanT, color = 'mean Temp')) +
  geom_line(aes(x = month, y = meanT, color = 'mean Temp')) +
  xlab('Date') + 
  ylab('Precipitation [cm]') + 
  scale_color_manual(" ", values = c('gray', 'darkred', 'black')) + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())
```
One final piece of pre-analysis - taking the 5 month anomaly values. This more clearly translates any results that may be minimized or exacerbated by seasonal trends. 

```{r}
data_monthly_anomaly = data_monthly_nogaps %>%
  mutate(across(meanPrecip:S2N_DP, ~ .x - rollmean(.x, k = 5, fill = NA, align = 'left')))


head(data_monthly_nogaps)
head(data_monthly_anomaly)
```
Plot anomalies

```{r}
#Precip
p1 = ggplot(data = data_monthly_anomaly) +
  geom_point(aes(x = month, y = meanPrecip, color = 'mean Precip')) +
  geom_line(aes(x = month, y = meanPrecip, color = 'mean Precip')) +
  geom_point(aes(x = month, y = totPrecip, color = 'total Precip')) +
  geom_line(aes(x = month, y = totPrecip, color = 'total Precip')) +
  geom_point(aes(x = month, y = meanT, color = 'mean Temp')) +
  geom_line(aes(x = month, y = meanT, color = 'mean Temp')) +
  xlab('Date') + 
  ylab('Precipitation [cm]') + 
  scale_color_manual(" ", values = c('gray', 'black', 'darkred')) + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

#Bog WTE
b1 = ggplot(data = data_monthly_anomaly, aes(x = month, y = meanWTE)) + 
  geom_point(color = 'gray') + 
  geom_line(color = 'gray') + 
  xlab('Date') + 
  ylab('Bog WTE [m]') +
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())


#SOIL 
s1 = ggplot(data = data_monthly_anomaly) +
  geom_line(aes(x = month, y = S2S_SH, color = 'S2S SH')) +
  geom_line(aes(x = month, y = S2S_DP, color = 'S2S DP'), linetype = 3) + 
  geom_line(aes(x = month, y = S2N_SH, color = 'S2N SH')) +
  geom_line(aes(x = month, y = S2N_DP, color = 'S2N DP'), linetype = 3) + 
  geom_point(aes(x = month, y = S2S_SH, color = 'S2S SH')) +
  geom_point(aes(x = month, y = S2S_DP, color = 'S2S DP')) + 
  geom_point(aes(x = month, y = S2N_SH, color = 'S2N SH')) +
  geom_point(aes(x = month, y = S2N_DP, color = 'S2N DP')) + 
  xlab('Date') +
  ylab('Soil Moisture [m3/m3]') +
  scale_color_manual(" ", values =  c("darkolivegreen3", "darkolivegreen3", "royalblue", "royalblue")) + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank()) 

#Streamflow
q1 = ggplot(data = data_monthly_anomaly) +
  geom_point(aes(x = month, y = meanQ, color = 'mean Q')) +
  geom_line(aes(x = month, y = meanQ, color = 'mean Q')) +
  geom_point(aes(x = month, y = totQ, color = 'total Q')) +
  geom_line(aes(x = month, y = totQ, color = 'total Q')) +
  xlab('Date') + 
  ylab('Streamflow [cm]') + 
  scale_color_manual(" ", values = c('gray', 'black')) +
  theme(legend.position = 'top',
        aspect.ratio = 0.3,
        panel.background = element_blank())

timeseries = plot_grid(p1, b1, s1, q1,
          labels = c('A', 'B', 'C', 'D'),
          label_size = 12,
          align="hv")

save_plot(paste0(fig_save, 'monthlydata_anomaly_timeseries.pdf'), timeseries, base_height = 5)
save_plot(paste0(fig_save, 'monthlydata_anomaly_timeseries.jpeg'), timeseries, base_height = 5)
timeseries
```


## Information Theory Lagg Analysis

```{r}
## Assume one immediate history
lagValue = 1

## Shift time series
lagTS = function(x, y, l){
  #Shift
  shiftedX = lag(x, n = l)
  shiftedY = lag(y, n = 0)
  
  #Merge into data frame and clip to non-na
  dat = data.frame(shiftedX, shiftedY) %>%
    drop_na()
  
  return(dat)
}
```

### Sample TE and MI diagrams

```{r}
#Calculate shifted values
shifted = lagTS(data_monthly$totPrecip, data_monthly$meanWTE, l = 3)
shifted_6months = lagTS(data_monthly$totPrecip, data_monthly$meanWTE, l = 6)

#Test plot lagged time series
b2 = ggplot() + 
  geom_point(data = data_monthly, aes(x = month, y = meanWTE), color = 'lightblue') + 
  geom_line(data = data_monthly, aes(x = month, y = meanWTE), color = 'lightblue') +
  geom_point(data = shifted, aes(x = data_monthly$month[1:70], y = shiftedY), color = 'royalblue') + 
  geom_line(data = shifted, aes(x = data_monthly$month[1:70], y = shiftedY), color = 'royalblue') +
  geom_point(data = shifted_6months, aes(x = data_monthly$month[1:67], y = shiftedY), color = 'darkblue') + 
  geom_line(data = shifted_6months, aes(x = data_monthly$month[1:67], y = shiftedY), color = 'darkblue') +
  xlab('Date') + 
  ylab('Mean Bog WTE [m]') +
  theme(aspect.ratio = 0.3, 
        panel.background = element_blank())

p2 = ggplot() + 
  geom_segment(data = data_monthly, aes(x = month, y = totPrecip, xend = month, yend = totPrecip-totPrecip), color = 'gray') + 
  geom_point(data = data_monthly, aes(x = month, y = totPrecip), color = 'gray') + 
  xlab('Date') + 
  ylab('Total Precip [cm]') +
  theme(aspect.ratio = 0.3, 
        panel.background = element_blank())

lagged_timeseries = plot_grid(b2, p2, 
          labels = c('A', 'B'), 
          align = 'hv', 
          ncol = 1)

save_plot(paste0(fig_save, 'sample_laggedtimeseries.pdf'), lagged_timeseries, base_height = 5)
save_plot(paste0(fig_save, 'sample_laggedtimeseries.jpeg'), lagged_timeseries, base_height = 5)
lagged_timeseries

```

```{r}
#Sample PDF distributions
preEntropy = round(entropy(discretize(data_monthly$meanWTE)), 2)
Entropy_3mo = round(entropy(discretize(shifted$shiftedY)), 2)
yEntropy_3mo = round(entropy(discretize(shifted$shiftedX)), 2)
Entropy_6mo = round(entropy(discretize(shifted_6months$shiftedY)), 2)
yEntropy_6mo = round(entropy(discretize(shifted_6months$shiftedX)), 2)

a1 = ggplot() + 
  geom_freqpoly(data = data_monthly, aes(x = meanWTE, after_stat(density)), color = 'lightblue', bins = 15, size = 1) + 
  geom_freqpoly(data = shifted, aes(x = shiftedY, after_stat(density)), color = 'royalblue', bins = 15, size = 1) +
  geom_freqpoly(data = shifted_6months, aes(x = shiftedY, after_stat(density)), color = 'darkblue', bins = 15, size = 1) +
  ylab('Density') + 
  xlab('Mean Bog WTE [m]') +
  ggtitle(TeX(sprintf("$H_{pre}$ = %0.2f, $H_{3mo}$ = %0.2f, $H_{6mo}$ = %0.2f", preEntropy, Entropy_3mo, Entropy_6mo))) + 
  theme(aspect.ratio = 0.7, 
        panel.background = element_blank())

b1 = ggplot() + 
  geom_freqpoly(data = data_monthly, aes(x = totPrecip, after_stat(density)), color = 'gray', bins = 15, size = 1) + 
  ylab('Density') + 
  xlab('Total Precip [cm]') +
  ggtitle(TeX(sprintf("$H_{y}$ = %0.2f", yEntropy))) + 
  theme(aspect.ratio = 0.7, 
        panel.background = element_blank())

histograms = plot_grid(a1, b1, 
          labels = c('A', 'B'), 
          align = 'hv', 
          ncol = 2)
save_plot(paste0(fig_save, 'sample_histogramtimeseries.pdf'), histograms, base_height = 5)
save_plot(paste0(fig_save, 'sample_histogramtimeseries.jpeg'), histograms, base_height = 5)

histograms
```


```{r}
#bivariate plots of pre-shifted and shifted
preMI = round(mutinformation(discretize(data_monthly$totPrecip), discretize(data_monthly$meanWTE)), 2)
MI_3mo = round(mutinformation(discretize(shifted$shiftedX), discretize(shifted$shiftedY)), 2)
MI_6mo = round(mutinformation(discretize(shifted_6months$shiftedX), discretize(shifted_6months$shiftedY)), 2)
preTE = transfer_entropy(discretize(data_monthly$totPrecip), discretize(data_monthly$meanWTE), lx = lagValue, ly = lagValue)$coef[1,1]
TE_3mo = transfer_entropy(shifted$shiftedX, shifted$shiftedY, lx = lagValue, ly = lagValue)$coef[1,1]
TE_6mo = transfer_entropy(shifted_6months$shiftedX, shifted_6months$shiftedY, lx = lagValue, ly = lagValue)$coef[1,1]

p1 = ggplot() + 
  geom_point(data = data_monthly, aes(x = totPrecip, y = meanWTE), color = 'lightblue') + 
  xlab('Total Precip [cm]') + 
  ylab('Mean Bog WTE [m]') +
  labs(subtitle = TeX(sprintf("$MI_{pre}$ = %0.2f, $TE_{pre}$ = %0.2f", preMI, preTE))) + 
  theme(aspect.ratio = 0.7, 
        panel.background = element_blank())

p2 = ggplot() + 
  geom_point(data = shifted, aes(x = shiftedX, y = shiftedY), color = 'royalblue') + 
  xlab('Total Precip [cm]') + 
  ylab('Mean Bog WTE [m]') +
  labs(subtitle = TeX(sprintf("$MI_{3mo}$ = %0.2f, $TE_{3mo}$ = %0.2f", MI_3mo, TE_3mo))) + 
  theme(aspect.ratio = 0.7, 
        panel.background = element_blank())

p3 = ggplot() + 
  geom_point(data = shifted_6months, aes(x = shiftedX, y = shiftedY), color = 'darkblue') + 
  xlab('Total Precip [cm]') + 
  ylab('Mean Bog WTE [m]') +
  labs(subtitle = TeX(sprintf("$MI_{6mo}$ = %0.2f, $TE_{6mo}$ = %0.2f", MI_6mo, TE_6mo))) + 
  theme(aspect.ratio = 0.7, 
        panel.background = element_blank())

bivariate_lag = plot_grid(p1, p2, p3, 
          labels = c('A', 'B', 'C'),
          align = 'hv',
          nrow = 1)
save_plot(paste0(fig_save, 'sample_bivariate.pdf'), bivariate_lag, base_height = 5)
save_plot(paste0(fig_save, 'sample_bivariate.jpeg'), bivariate_lag, base_height = 5)

bivariate_lag
```

```{r}
#bivariate plots of pre-shifted and shifted at various look back periods
#Lookback two months
preTE_2moLookback = transfer_entropy(discretize(data_monthly$totPrecip), discretize(data_monthly$meanWTE), lx = 2, ly = 2)$coef[1,1]
TE_3mo_2moLookback = transfer_entropy(shifted$shiftedX, shifted$shiftedY, lx = 2, ly = 2)$coef[1,1]
TE_6mo_2moLookback = transfer_entropy(shifted_6months$shiftedX, shifted_6months$shiftedY, lx = 2, ly = 2)$coef[1,1]

#Lookback three months
preTE_3moLookback = transfer_entropy(discretize(data_monthly$totPrecip), discretize(data_monthly$meanWTE), lx = 3, ly = 3)$coef[1,1]
TE_3mo_3moLookback = transfer_entropy(shifted$shiftedX, shifted$shiftedY, lx = 3, ly = 3)$coef[1,1]
TE_6mo_3moLookback = transfer_entropy(shifted_6months$shiftedX, shifted_6months$shiftedY, lx = 3, ly = 3)$coef[1,1]


p1.1 = ggplot() + 
  geom_point(data = data_monthly, aes(x = totPrecip, y = meanWTE), color = 'lightblue') + 
  xlab('Total Precip [cm]') + 
  ylab('Mean Bog WTE [m]') +
  labs(subtitle = TeX(sprintf("$MI_{pre}$ = %0.2f, $TE_{pre}$ = %0.2f", preMI, preTE_2moLookback))) + 
  theme(aspect.ratio = 0.7, 
        panel.background = element_blank())

p2.1 = ggplot() + 
  geom_point(data = shifted, aes(x = shiftedX, y = shiftedY), color = 'royalblue') + 
  xlab('Total Precip [cm]') + 
  ylab('Mean Bog WTE [m]') +
  labs(subtitle = TeX(sprintf("$MI_{3mo}$ = %0.2f, $TE_{3mo}$ = %0.2f", MI_3mo, TE_3mo_2moLookback))) + 
  theme(aspect.ratio = 0.7, 
        panel.background = element_blank())

p3.1 = ggplot() + 
  geom_point(data = shifted_6months, aes(x = shiftedX, y = shiftedY), color = 'darkblue') + 
  xlab('Total Precip [cm]') + 
  ylab('Mean Bog WTE [m]') +
  labs(subtitle = TeX(sprintf("$MI_{6mo}$ = %0.2f, $TE_{6mo}$ = %0.2f", MI_6mo, TE_6mo_2moLookback))) + 
  theme(aspect.ratio = 0.7, 
        panel.background = element_blank())

p1.2 = ggplot() + 
  geom_point(data = data_monthly, aes(x = totPrecip, y = meanWTE), color = 'lightblue') + 
  xlab('Total Precip [cm]') + 
  ylab('Mean Bog WTE [m]') +
  labs(subtitle = TeX(sprintf("$MI_{pre}$ = %0.2f, $TE_{pre}$ = %0.2f", preMI, preTE_3moLookback))) + 
  theme(aspect.ratio = 0.7, 
        panel.background = element_blank())

p2.2 = ggplot() + 
  geom_point(data = shifted, aes(x = shiftedX, y = shiftedY), color = 'royalblue') + 
  xlab('Total Precip [cm]') + 
  ylab('Mean Bog WTE [m]') +
  labs(subtitle = TeX(sprintf("$MI_{3mo}$ = %0.2f, $TE_{3mo}$ = %0.2f", MI_3mo, TE_3mo_3moLookback))) + 
  theme(aspect.ratio = 0.7, 
        panel.background = element_blank())

p3.2 = ggplot() + 
  geom_point(data = shifted_6months, aes(x = shiftedX, y = shiftedY), color = 'darkblue') + 
  xlab('Total Precip [cm]') + 
  ylab('Mean Bog WTE [m]') +
  labs(subtitle = TeX(sprintf("$MI_{6mo}$ = %0.2f, $TE_{6mo}$ = %0.2f", MI_6mo, TE_6mo_3moLookback))) + 
  theme(aspect.ratio = 0.7, 
        panel.background = element_blank())

bivariate_lag_lookback = plot_grid(p1, p2, p3, #original plots
                          p1.1, p2.1, p3.1, 
                          p1.2, p2.2, p3.2,
          #labels = c('A', 'B', 'C', 'A.1', 'B.1', 'C.1', 'A.2', 'B.2', 'C.2'),
          align = 'hv',
          nrow = 3, 
          ncol = 3)
save_plot(paste0(fig_save, 'sample_bivariate_lookback.pdf'), bivariate_lag_lookback, base_height = 6)
save_plot(paste0(fig_save, 'sample_bivariate_lookback.jpeg'), bivariate_lag_lookback, base_height = 6)

bivariate_lag_lookback

```


A sample of what the lagged time series looks like for the water table elevation. Note that the way the algorithm is written we are technically shifting the dependent (Y) timeseries forward in time, not the independent (X) timeseries backward in time. 

```{r}
te = transfer_entropy(shifted$shiftedX, shifted$shiftedY, lx = lagValue, ly = lagValue)
te
```

What this gives is a value for TE in both the forward (X -> Y) direction and the reverse direction (Y -> X) and a value for the critical threshold TE based on 100 shuffles of the time series. Then we can also do a one (or two) tailed hypothesis test for significant information flow. 

We can then perform this analysis over many lags in a loop in order to find the transfer entropy flows at various time lags and eventually determine a maximum time lag for each hydrologic/information flow. 

```{r}
#Take out the non-useful columns
data_monthly_reduced = data_monthly_anomaly %>%
  select(-c(month, meanPrecip, meanQ))

#Collect combinations of variables
combinations_x = c("totPrecip", "totPrecip", "totPrecip", "totPrecip", "totPrecip", "totPrecip",
                   "meanWTE", 
                   "S2S_SH" , "S2S_SH", 
                   "S2N_SH" , "S2N_SH", 
                   "S2S_DP", 
                   "S2N_DP", 
                   "meanT", "meanT", "meanT", "meanT", "meanT", "meanT")
combinations_y = c("meanWTE", "totQ",  "S2S_SH", "S2S_DP", "S2N_SH", "S2N_DP", 
                   "totQ",
                   "S2S_DP", "totQ", 
                   "S2N_DP", "totQ", 
                   "totQ",
                   "totQ", 
                   "meanWTE", "totQ", "S2S_SH", "S2S_DP", "S2N_SH", "S2N_DP")
```


```{r}
#Lags to test
lags = 18
#Empty dataframe to contain te information
te_df = data.frame(matrix(ncol = 0, nrow = lags))


for(k in seq(1, length(combinations_x))){
    #Reset
    te_results_for = c()
    
    #Assign variables
    #significant TE
    i = combinations_x[k]
    j = combinations_y[k]
    
    #all te and tcrit
    allte = c()
    tecrit = c()
    
    #Loop through lags
    for(l in seq(1, lags)){
      #Shift data
      shifted = lagTS(data_monthly_reduced[i], data_monthly_reduced[j], l = l)
      
      #Compute TE
      te = transfer_entropy(shifted[i], shifted[j], quiet = TRUE, seed = 12345)
      
      #Add to full te list
      allte[l] = te$coef[1,1]
      tecrit[l] = mean(te$boot["dtexy",]) + 1.66*sd(te$boot["dtexy",])
      
      #If significant, add to other list, else na
      if(te$coef[1,4] < 0.05){
        te_results_for[l] = te$coef[1,1]
      }
      else{
        te_results_for[l] = NaN
      }
    }
    
    #Create and save TE plots
    lag_plot = ggplot() + 
            geom_point(aes(x = seq(1, lags), y = allte), color = 'royalblue') + 
            geom_line(aes(x = seq(1, lags), y = allte), color = 'royalblue') +
            geom_point(aes(x = seq(1, lags), y = tecrit), color = 'lightgray') + 
            geom_line(aes(x = seq(1, lags), y = tecrit), color = 'lightgray') +
            xlab('Lag') + 
            ylab('Transfer Entropy') +
            labs(subtitle = paste0(i, '->', j)) +
            theme(aspect.ratio = 0.3, 
                  panel.background = element_blank())
    save_plot(paste0(fig_save, 'lag plots/', i, '->', j, '-lagg-series.pdf'), lag_plot, base_height = 2, base_asp = 3)
    save_plot(paste0(fig_save, 'lag plots/', i, '->', j, '-lagg-series.jpeg'), lag_plot, base_height = 2, base_asp = 3)
              
    #Assign to dataframe
    te_df[paste0(i, '->', j)] = te_results_for
}
```

```{r}
head(te_df)
```

```{r}
#Heat map plot

#Melt data
te_df['lag'] = seq(1, lags)
te_df_melt = melt(te_df, id.vars = 'lag')

#Plot
lag_heatmap = ggplot(te_df_melt, aes(lag, variable)) +
  geom_tile(aes(fill = value), color = 'lightgray', lwd = 0.5, linetype = 1) +
  geom_text(aes(label = round(value, 2)), size = 3, color ='white') +
  scale_fill_gradient("Transfer Entropy", low = "lightblue", high = "deepskyblue4", na.value = 'white')+
  theme(panel.background = element_blank()) + 
  xlab("Time Lag [months]") + 
  ylab(" ")

save_plot(paste0(fig_save, 'laggedheatmap.pdf'), lag_heatmap, base_height = 5, base_asp = 2)
save_plot(paste0(fig_save, 'laggedheatmap.jpeg'), lag_heatmap, base_height = 5, base_asp = 2)
lag_heatmap
```


```{r}
#Full Adjacency matrix
vars = c("totPrecip", "meanWTE", "totQ",  "S2S_SH", "S2S_DP", "S2N_SH", "S2N_DP", "meanT")

A_te = array(dim = c(length(vars), length(vars), lags))
A_crit = array(dim = c(length(vars), length(vars), lags))

for(i in seq(1, length(vars))){
  for(j in seq(1, length(vars))){
    #Assign variables
    iv = vars[i]
    jv = vars[j]
    
    #Loop through lags
    for(l in seq(1, lags)){
      #Shift data
      shifted = lagTS(data_monthly_reduced[iv], data_monthly_reduced[jv], l = l)
      
      #Compute TE
      te = transfer_entropy(shifted[iv], shifted[jv], quiet = TRUE, seed = 12345, entropy = 'Shannon', shuffles = 300)
      
      #Add to full te list
      A_te[i, j, l] = te$coef[1,1]
      A_crit[i, j, l] = mean(te$boot["dtexy",]) + 1.66*sd(te$boot["dtexy",])
    }
  }
}

```

```{r}
#Watershed subsystem
A_watershed = A_te[-c(1, 3), -c(1, 3) , ]
A_south = A_te[c(4, 5), c(4, 5), ]
A_north = A_te[c(6, 7), c(6, 7), ]

#Watershed subsystems with only significant TE values
mask = A_te > A_crit
A_sig = replace(A_te, !mask, NA)
A_watershed_sig = A_sig[-c(1, 3), -c(1, 3) , ]
A_south_sig = A_sig[c(4, 5), c(4, 5), ]
A_north_sig = A_sig[c(6, 7), c(6, 7), ]
```

### Process Network

```{r}
#Find lags with max information transfer
maxLag = array(dim = c(length(vars), length(vars), 1))
maxLagTE = array(dim = c(length(vars), length(vars), 1))

for(i in 1:length(vars)){
  for(j in 1:length(vars)){
    if(TRUE %in% mask[i, j, ]) maxLagTE[i, j, 1]=max(A_sig[i, j, ], na.rm = TRUE) else maxLagTE[i, j, 1]=NA
    if(TRUE %in% mask[i, j, ]) maxLag[i, j, 1]=which.max(A_sig[i, j, ]) else maxLag[i, j, 1]=NA
  }
}
```

At these lags we are interested in seeing if the information flows are feedback or forcing dominated. To do this we look at the mutual information between the time series at the same lag. If:

- T > I then it is forcing dominated
- T < I then it is feedback dominated

```{r}
MI = array(dim = c(length(vars), length(vars), 1))

#discretize data for MI calculation
data_monthly_discretized = discretize(data_monthly_reduced, disc="equalfreq", nbins=15)

#Loop through variables - calculate the MI at the zero lag and save it 
for(i in 1:length(vars)){
  for(j in 1:length(vars)){
      #Assign variables
      iv = vars[i]
      jv = vars[j]
      
      #Compute zero-lag MI and convert to base 2
      MI[i, j, 1] = natstobits(mutinformation(data_monthly_discretized[iv], data_monthly_discretized[jv], method="emp"))
      
      #Compare and share
      #if(MI[i, j, 1] > maxLagTE[i, j, 1]){
      #  print(paste(iv, '-->', jv, 'is feedback dominated at lag', maxLag[i, j, 1], 'months'))
      #} else{
      #  print(paste(iv, '-->', jv, 'is forcing dominated at lag', maxLag[i, j, 1], 'months'))
      #}
  }
}
```

```{r}
#Make plots of the synchronization ratio Tz
for(i in 1:length(vars)){
  for(j in 1:length(vars)){
    #Filter out data
    te_temp = A_te[i, j, ]
    te_crit_temp = A_crit[i, j, ]
    mi_temp = MI[i, j, 1]
    tz_temp = te_temp/mi_temp
    iv = vars[i]
    jv = vars[j]
    
    #Plot
    #Create and save TE plots
    lag_plot = ggplot() + 
            #Transfer Entropy 
            geom_point(aes(x = seq(1, lags), y = te_temp, color = 'TE')) + 
            geom_line(aes(x = seq(1, lags), y = te_temp, color = 'TE')) +
            #Critical Transfer Entropy
            geom_point(aes(x = seq(1, lags), y = te_crit_temp, color = 'critTE')) + 
            geom_line(aes(x = seq(1, lags), y = te_crit_temp, color = 'critTE')) +
            #Mutual Information
            #geom_point(aes(x = seq(1, lags), y = mi_temp, color = 'MI')) + 
            #geom_line(aes(x = seq(1, lags), y = mi_temp, color = 'MI')) +
            #Synchro Ratio
            geom_point(aes(x = seq(1, lags), y = tz_temp, color = 'Tz')) + 
            geom_line(aes(x = seq(1, lags), y = tz_temp, color = 'Tz')) +
            scale_color_manual(" ", values =  c("darkred", "lightgrey", "royalblue")) + 
            xlab('Lag') + 
            ylab('Information Transfer [bits]') +
            labs(subtitle = paste0(iv, '->', jv)) +
            theme(aspect.ratio = 0.3, 
                  panel.background = element_blank())
    save_plot(paste0(fig_save, 'synchroRatioPlots/', iv, '->', jv, '-lagg-series.pdf'), lag_plot, base_height = 2, base_asp = 3)
    save_plot(paste0(fig_save, 'synchroRatioPlots/', iv, '->', jv, '-lagg-series.jpeg'), lag_plot, base_height = 2, base_asp = 3)
  }
}

```

```{r}
notSig = ggplot() + 
  #Total information flow within the system
  geom_line(aes(x = seq(1, 18), y = colSums(A_te, dims = 2), color = 'Total')) + 
  geom_point(aes(x = seq(1, 18), y = colSums(A_te, dims = 2), color = 'Total')) + 
  #Total information exchange within the system (no P or Q)
  geom_line(aes(x = seq(1, 18), y = colSums(A_watershed, dims = 2), color = 'Watershed')) +
  geom_point(aes(x = seq(1, 18), y = colSums(A_watershed, dims = 2), color = 'Watershed')) +  
  #Total information exchange in the south hillslope
  
  geom_line(aes(x = seq(1, 18), y = colSums(A_south, dims = 2), color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = colSums(A_south, dims = 2), color = 'South Hillslope')) +
  #Total information exchange in the north hillslope
  geom_line(aes(x = seq(1, 18), y = colSums(A_north, dims = 2), color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = colSums(A_north, dims = 2), color = 'North Hillslope')) + 
  labs(x = 'Lag', y = 'Total System Information Transfer') + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue", "black", "darkred")) + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

Sig = ggplot() + 
  #Total information flow within the system
  geom_line(aes(x = seq(1, 18), y = colSums(A_sig, dims = 2, na.rm = TRUE), color = 'Total')) + 
  geom_point(aes(x = seq(1, 18), y = colSums(A_sig, dims = 2, na.rm = TRUE), color = 'Total')) + 
  #Total information exchange within the system (no P or Q)
  geom_line(aes(x = seq(1, 18), y = colSums(A_watershed_sig, dims = 2, na.rm = TRUE), color = 'Watershed')) +
  geom_point(aes(x = seq(1, 18), y = colSums(A_watershed_sig, dims = 2, na.rm = TRUE), color = 'Watershed')) +  
  #Total information exchange in the south hillslope
  geom_line(aes(x = seq(1, 18), y = colSums(A_south_sig, dims = 2, na.rm = TRUE), color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = colSums(A_south_sig, dims = 2, na.rm = TRUE), color = 'South Hillslope')) +
  #Total information exchange in the north hillslope
  geom_line(aes(x = seq(1, 18), y = colSums(A_north_sig, dims = 2, na.rm = TRUE), color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = colSums(A_north_sig, dims = 2, na.rm = TRUE), color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue", "black", "darkred")) + 
  labs(x = 'Lag', y = ' ') + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

plot_grid(notSig, Sig, 
          labels = c('A', 'B'), 
          align = 'hv', 
          ncol = 1)
  
```

There is more significant information flow between soil layers on the north hillslope than the south hillslope. 

The north hillslope seems to have more overall information transfer than the south hillslope, is there a signficant difference in the turnover of water on the north hillslope? This could be due to the fact that the north hillslope is south facing so there is higher ET, snow melt rates, etc. which leads to more turnover in the soil moisture
signatures.

Based on the data, the theory here is that higher soil moisture in the deeper layers on the south hillslope due to lower ET limit which simply encourages lateral runoff instead of infiltration into the deeper soil layers. If this were true, then the effect would be more pronounced at lower hillslopes and we would see input from shallow soil moisture at high elevation into shallow soil moisture at lower elevation.

## Hillslope Specific Networks

```{r}
#Group soil moisture, un-lumped by hillslope and depth, data into monthly bins for separate analysis
sm_daily$month = floor_date(sm_daily$day, "month")
sm_monthly = sm_daily %>%
  group_by(month) %>%
  summarize_all(mean, na.rm = TRUE)

#Clip to same timescale as other data
sm_monthly = merge(sm_monthly,
             data.frame(times = floor_date(seq(from = as.POSIXct('2011-02-03'), to = as.POSIXct('2017-02-28'), by = "month"), 'month')), 
             by.x = 'month', by.y = 'times', 
             all.y = TRUE) %>%
  select(-c(day))

#Gap fill
sm_monthly_nogaps = sm_monthly %>%
   mutate(across(starts_with("S2"), ~ na.approx(.x, na.rm = FALSE))) 

#Anomaly
sm_monthly_anomaly = sm_monthly_nogaps %>%
  mutate(across(S2S_UP_SH:S2N_LO_DP, ~ .x - rollmean(.x, k = 5, fill = NA, align = 'left')))


summary(sm_monthly_anomaly)
```


```{r}
smUP = ggplot(data = sm_monthly_nogaps) +
  geom_line(aes(x = month, y = S2S_UP_SH, color = 'S2S SH')) +
  geom_line(aes(x = month, y = S2S_UP_DP, color = 'S2S DP'), linetype = 3) + 
  geom_line(aes(x = month, y = S2N_UP_SH, color = 'S2N SH')) +
  geom_line(aes(x = month, y = S2N_UP_DP, color = 'S2N DP'), linetype = 3) + 
  geom_point(aes(x = month, y = S2S_UP_SH, color = 'S2S SH')) +
  geom_point(aes(x = month, y = S2S_UP_DP, color = 'S2S DP')) + 
  geom_point(aes(x = month, y = S2N_UP_SH, color = 'S2N SH')) +
  geom_point(aes(x = month, y = S2N_UP_DP, color = 'S2N DP')) + 
  xlab('Date') +
  ylab('Soil Moisture [m3/m3]') +
  scale_color_manual(" ", values =  c("darkolivegreen3", "darkolivegreen3", "royalblue", "royalblue")) + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank()) 

smMI = ggplot(data = sm_monthly_nogaps) +
  geom_line(aes(x = month, y = S2S_MI_SH, color = 'S2S SH')) +
  geom_line(aes(x = month, y = S2S_MI_DP, color = 'S2S DP'), linetype = 3) + 
  geom_line(aes(x = month, y = S2N_MI_SH, color = 'S2N SH')) +
  geom_line(aes(x = month, y = S2N_MI_DP, color = 'S2N DP'), linetype = 3) + 
  geom_point(aes(x = month, y = S2S_MI_SH, color = 'S2S SH')) +
  geom_point(aes(x = month, y = S2S_MI_DP, color = 'S2S DP')) + 
  geom_point(aes(x = month, y = S2N_MI_SH, color = 'S2N SH')) +
  geom_point(aes(x = month, y = S2N_MI_DP, color = 'S2N DP')) + 
  xlab('Date') +
  ylab('Soil Moisture [m3/m3]') +
  scale_color_manual(" ", values =  c("darkolivegreen3", "darkolivegreen3", "royalblue", "royalblue")) + 
  theme(legend.position = 'None',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

smLO = ggplot(data = sm_monthly_nogaps) +
  geom_line(aes(x = month, y = S2S_LO_SH, color = 'S2S SH')) +
  geom_line(aes(x = month, y = S2S_LO_DP, color = 'S2S DP'), linetype = 3) + 
  geom_line(aes(x = month, y = S2N_LO_SH, color = 'S2N SH')) +
  geom_line(aes(x = month, y = S2N_LO_DP, color = 'S2N DP'), linetype = 3) + 
  geom_point(aes(x = month, y = S2S_LO_SH, color = 'S2S SH')) +
  geom_point(aes(x = month, y = S2S_LO_DP, color = 'S2S DP')) + 
  geom_point(aes(x = month, y = S2N_LO_SH, color = 'S2N SH')) +
  geom_point(aes(x = month, y = S2N_LO_DP, color = 'S2N DP')) + 
  xlab('Date') +
  ylab('Soil Moisture [m3/m3]') +
  scale_color_manual(" ", values =  c("darkolivegreen3", "darkolivegreen3", "royalblue", "royalblue")) + 
  theme(legend.position = 'None',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

sm_hillslopes = plot_grid(smUP, smMI, smLO, 
          labels = c('UP', 'MI', 'LO'), 
          align = 'hv', 
          ncol = 1)
save_plot(paste0(fig_save, 'sample_soilMhillslopes.pdf'), sm_hillslopes, base_height = 8)
save_plot(paste0(fig_save, 'sample_soilMhillslopes.jpeg'), sm_hillslopes, base_height = 8)
sm_hillslopes

```

```{r}
#South Hillslope Adjacency matrix
vars = c("S2S_UP_SH", "S2S_UP_DP", "S2S_MI_SH", "S2S_MI_DP", "S2S_LO_SH", "S2S_LO_DP")

A_southhill_te = array(dim = c(length(vars), length(vars), lags))
A_southhill_crit = array(dim = c(length(vars), length(vars), lags))

for(i in seq(1, length(vars))){
  for(j in seq(1, length(vars))){
    #Assign variables
    iv = vars[i]
    jv = vars[j]
    
    #Loop through lags
    for(l in seq(1, lags)){
      #Shift data
      shifted = lagTS(sm_monthly_anomaly[iv], sm_monthly_anomaly[jv], l = l)
      
      #Compute TE
      te = transfer_entropy(shifted[iv], shifted[jv], quiet = TRUE, seed = 12345)
      
      #Add to full te list
      A_southhill_te[i, j, l] = te$coef[1,1]
      A_southhill_crit[i, j, l] = mean(te$boot["dtexy",]) + 1.66*sd(te$boot["dtexy",])
    }
  }
}
```

```{r}
#North Hillslope Adjacency matrix
vars = c("S2N_UP_SH", "S2N_UP_DP", "S2N_MI_SH", "S2N_MI_DP", "S2N_LO_SH", "S2N_LO_DP")

A_northhill_te = array(dim = c(length(vars), length(vars), lags))
A_northhill_crit = array(dim = c(length(vars), length(vars), lags))

for(i in seq(1, length(vars))){
  for(j in seq(1, length(vars))){
    #Assign variables
    iv = vars[i]
    jv = vars[j]
    
    #Loop through lags
    for(l in seq(1, lags)){
      #Shift data
      shifted = lagTS(sm_monthly_anomaly[iv], sm_monthly_anomaly[jv], l = l)
      
      #Compute TE
      te = transfer_entropy(shifted[iv], shifted[jv], quiet = TRUE, seed = 12345)
      
      #Add to full te list
      A_northhill_te[i, j, l] = te$coef[1,1]
      A_northhill_crit[i, j, l] = mean(te$boot["dtexy",]) + 1.66*sd(te$boot["dtexy",])
    }
  }
}
```

```{r}
#Calculate out significant values
maskSouth = A_southhill_te > A_southhill_crit
A_southhill = replace(A_southhill_te, !maskSouth, NA)

maskNorth = A_northhill_te > A_northhill_crit
A_northhill = replace(A_northhill_te, !maskNorth, NA)
```

```{r}
#Reformatting for heatmap plotting
#[1]"UP_SH", [2]"UP_DP", [3]"MI_SH", [4]"MI_DP", [5]"LO_SH", [6]"LO_DP"
south_plotting = data.frame(
  #UP_SH -> UP_DP
  'UP_SH-UP_DP' = A_southhill[1,2,],
  #MI_SH -> MI_DP
  'MI_SH-MI_DP' = A_southhill[3,4,], 
  #LO_SH -> LO_DP
  'LO_SH-LO_DP' = A_southhill[5,6,], 
  #UP_SH -> MI_SH
  'UP_SH-MI_SH' = A_southhill[1,3,],
  #MI_SH -> LO_SH
  'MI_SH-LO_SH' = A_southhill[3,5,],
  #UP_DP -> MI_DP
  'UP_DP-MI_DP' = A_southhill[2,4,],
  #MI_DP -> LO_DP
  'MI_DP-LO_DP' = A_southhill[4,6,], 
  'lag' = seq(1, lags)) %>%
  melt(id.vars = 'lag')

north_plotting = data.frame(
  #UP_SH -> UP_DP
  'UP_SH-UP_DP' = A_northhill[1,2,],
  #MI_SH -> MI_DP
  'MI_SH-MI_DP' = A_northhill[3,4,], 
  #LO_SH -> LO_DP
  'LO_SH-LO_DP' = A_northhill[5,6,], 
  #UP_SH -> MI_SH
  'UP_SH-MI_SH' = A_northhill[1,3,],
  #MI_SH -> LO_SH
  'MI_SH-LO_SH' = A_northhill[3,5,],
  #UP_DP -> MI_DP
  'UP_DP-MI_DP' = A_northhill[2,4,],
  #MI_DP -> LO_DP
  'MI_DP-LO_DP' = A_northhill[4,6,],
  'lag' = seq(1, lags)) %>%
  melt(id.vars = 'lag')
```

```{r}
#Hillslope heatmaps
#Plot
south_heatmap = ggplot(south_plotting, aes(lag, variable)) +
  geom_tile(aes(fill = value), color = 'lightgray', lwd = 0.5, linetype = 1) +
  geom_text(aes(label = round(value, 2)), size = 3, color ='white') +
  scale_fill_gradient("Transfer Entropy", low = "lightblue", high = "deepskyblue4", na.value = 'white',
                      limits = c(0.03, 0.180))+
  theme(panel.background = element_blank()) + 
  xlab("Time Lag [months]") + 
  ylab(" ")

north_heatmap = ggplot(north_plotting, aes(lag, variable)) +
  geom_tile(aes(fill = value), color = 'lightgray', lwd = 0.5, linetype = 1) +
  geom_text(aes(label = round(value, 2)), size = 3, color ='white') +
  scale_fill_gradient("Transfer Entropy", low = "lightblue", high = "deepskyblue4", na.value = 'white',
                      limits = c(0.03, 0.180))+
  theme(panel.background = element_blank()) + 
  xlab("Time Lag [months]") + 
  ylab(" ")

hillslope_heatmaps = plot_grid(south_heatmap, north_heatmap, 
          labels = c('S', 'N'), 
          align = 'hv', 
          ncol = 1)

save_plot(paste0(fig_save, 'hillslopeheatmap.pdf'), hillslope_heatmaps, base_height = 5, base_asp = 2)
save_plot(paste0(fig_save, 'hillslopeheatmap.jpeg'), hillslope_heatmaps, base_height = 5, base_asp = 2)
hillslope_heatmaps
```

There continues to appear to be more information transfer in the north slope than the south slope but let's separate into line plots to see more clearly again. 

```{r}
#[1]"UP_SH", [2]"UP_DP", [3]"MI_SH", [4]"MI_DP", [5]"LO_SH", [6]"LO_DP"
#Fill Nans for plotting
A_southhill[is.na(A_southhill)] = 0
A_northhill[is.na(A_northhill)] = 0

#UP to MI, Shallow
upmi_shallow = ggplot() +  
  #south hillslope
  geom_line(aes(x = seq(1, 18), y = A_southhill[1, 3, ],
                color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_southhill[1, 3, ],
                color = 'South Hillslope')) + 
  #north hillslope
  geom_line(aes(x = seq(1, 18), y = A_northhill[1, 3,],
                color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_northhill[1, 3,],
                color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue")) + 
  labs(x = 'Lag', y = ' ', subtitle = 'Upland to Middle Hillslope, Shallow') + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

#MI to LO, Shallow
milo_shallow = ggplot() +  
  #south hillslope
  geom_line(aes(x = seq(1, 18), y = A_southhill[3, 5, ],
                color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_southhill[3, 5, ],
                color = 'South Hillslope')) + 
  #north hillslope
  geom_line(aes(x = seq(1, 18), y = A_northhill[3, 5, ],
                color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_northhill[3, 5, ],
                color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue")) + 
  labs(x = 'Lag', y = ' ', subtitle = 'Middle to Low Hillslope, Shallow') + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

#UP to MI, Deep
upmi_deep = ggplot() +  
  #south hillslope
  geom_line(aes(x = seq(1, 18), y = A_southhill[2, 4, ],
                color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_southhill[2, 4, ],
                color = 'South Hillslope')) + 
  #north hillslope
  geom_line(aes(x = seq(1, 18), y = A_northhill[2, 4, ],
                color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_northhill[2, 4, ],
                color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue")) + 
  labs(x = 'Lag', y = ' ', subtitle = 'Upland to Middle Hillslope, Deep') + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

#MI to LO, Deep
milo_deep = ggplot() +  
  #south hillslope
  geom_line(aes(x = seq(1, 18), y = A_southhill[4, 6, ],
                color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_southhill[4, 6, ],
                color = 'South Hillslope')) + 
  #north hillslope
  geom_line(aes(x = seq(1, 18), y = A_northhill[4, 6, ],
                color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_northhill[4, 6, ],
                color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue")) + 
  labs(x = 'Lag', y = ' ', subtitle = 'Middle to Low Hillslope, Deep') + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

hillslope_timeseries = plot_grid(upmi_shallow, milo_shallow, upmi_deep, milo_deep,
          labels = c('A', 'B', 'C', 'D'), 
          align = 'hv', 
          ncol = 2)
save_plot(paste0(fig_save, 'hillslopetimeseries.pdf'), hillslope_timeseries, base_height = 5, base_asp = 2)
save_plot(paste0(fig_save, 'hillslopetimeseries.jpeg'), hillslope_timeseries, base_height = 5, base_asp = 2)
hillslope_timeseries

```

```{r}
#[1]"UP_SH", [2]"UP_DP", [3]"MI_SH", [4]"MI_DP", [5]"LO_SH", [6]"LO_DP"
#UP 
up_infil = ggplot() +  
  #south hillslope
  geom_line(aes(x = seq(1, 18), y = A_southhill[1, 2, ],
                color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_southhill[1, 2, ],
                color = 'South Hillslope')) + 
  #north hillslope
  geom_line(aes(x = seq(1, 18), y = A_northhill[1, 2,],
                color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_northhill[1, 2,],
                color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue")) + 
  labs(x = 'Lag', y = ' ', subtitle = 'Upland Shallow to Deep') + 
  theme(legend.position = 'top',
        panel.background = element_blank())

#MI 
mi_infil = ggplot() +  
  #south hillslope
  geom_line(aes(x = seq(1, 18), y = A_southhill[3, 4, ],
                color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_southhill[3, 4, ],
                color = 'South Hillslope')) + 
  #north hillslope
  geom_line(aes(x = seq(1, 18), y = A_northhill[3, 4, ],
                color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_northhill[3, 4, ],
                color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue")) + 
  labs(x = 'Lag', y = ' ', subtitle = 'Middle Shallow to Deep') + 
  theme(legend.position = 'None',
        panel.background = element_blank())

#UP
lo_infil = ggplot() +  
  #south hillslope
  geom_line(aes(x = seq(1, 18), y = A_southhill[5, 6, ],
                color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_southhill[5, 6, ],
                color = 'South Hillslope')) + 
  #north hillslope
  geom_line(aes(x = seq(1, 18), y = A_northhill[5, 6, ],
                color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_northhill[5, 6, ],
                color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue")) + 
  labs(x = 'Lag', y = ' ', subtitle = 'Lowland Shallow to Deep') + 
  theme(legend.position = 'None',
        panel.background = element_blank())

infiltration_timeseries = plot_grid(up_infil, mi_infil, lo_infil,
          labels = c('A', 'B', 'C'), 
          align = 'hv', 
          ncol = 1)
save_plot(paste0(fig_save, 'infiltrationtimeseries.pdf'), infiltration_timeseries, base_height = 6, base_asp = 0.8)
save_plot(paste0(fig_save, 'infiltrationtimeseries.jpeg'), infiltration_timeseries, base_height = 6, base_asp = 0.8)
infiltration_timeseries
```

## Adding snow and seasonal representation

```{r}
#Import snow data
snow = read.csv(paste0(load_path, 'GR_ForestryLab_snow_daily.csv'), 
                col.names = c('Date', 'maxT_F', 'minT_F', 'P_in', 'Snow_in', 'SD_in'), 
                na.strings = c('T', 'M', 'S', 'A')
                )

#Trim to date range
snow = merge(snow,
             data.frame(times = floor_date(seq(from = as.POSIXct('2011-02-03'), to = as.POSIXct('2017-02-28'), by = "day"), 'day')), 
             by.x = 'Date', by.y = 'times', 
             all.y = TRUE) 

#Aggregate
snow$Date = as.POSIXct(snow$Date,format="%Y-%m-%d")
snow$month = floor_date(snow$Date, "month")
snow_monthly = snow %>%
  group_by(month) %>%
  select(c(P_in, Snow_in, month)) %>%
  summarize_all(sum, na.rm = TRUE) %>%
  rename(totPrecip = P_in, totSnow = Snow_in) %>%
  mutate_at(vars('totPrecip', 'totSnow'), funs(. * 2.54))
```

```{r}
summary(snow_monthly)
```

```{r}
#Merge with gap filled monthly data and run adjacency matrix
data_monthly_snow = merge(data_monthly_nogaps, snow_monthly[c('month', 'totSnow')], by = 'month')

#Take 5 month anomaly
data_monthly_snow_anomaly = data_monthly_snow %>%
  mutate(across(meanPrecip:totSnow, ~ .x - rollmean(.x, k = 5, fill = NA, align = 'left')))
```


```{r}
#Full Adjacency matrix
vars = c("totPrecip", "meanWTE", "totQ",  "S2S_SH", "S2S_DP", "S2N_SH", "S2N_DP", "totSnow", "meanT")

A_te_snow = array(dim = c(length(vars), length(vars), lags))
A_crit_snow = array(dim = c(length(vars), length(vars), lags))

for(i in seq(1, length(vars))){
  for(j in seq(1, length(vars))){
    #Assign variables
    iv = vars[i]
   jv = vars[j]
    
    #Loop through lags
    for(l in seq(1, lags)){
      #Shift data
      shifted = lagTS(data_monthly_snow_anomaly[iv], data_monthly_snow_anomaly[jv], l = l)
      
      #Compute TE
      te = transfer_entropy(shifted[iv], shifted[jv], quiet = TRUE, seed = 12345)
      
      #Add to full te list
      A_te_snow[i, j, l] = te$coef[1,1]
      A_crit_snow[i, j, l] = mean(te$boot["dtexy",]) + 1.66*sd(te$boot["dtexy",])
    }
  }
}
```


```{r}
#Only significant values
maskSnow = A_te_snow > A_crit_snow
A_snow = replace(A_te_snow, !maskSnow, NA)

#Reformatting for plotting
#[1]"totPrecip", [2]"meanWTE", [3]"totQ",  [4]"S2S_SH", [5]"S2S_DP", [6]"S2N_SH", [7]"S2N_DP", [8]"totSnow", [9]"meanT"
snow_plotting = data.frame(
  #totSnow -> meanWTE
  'totSnow-meanWTE' = A_snow[8,2,],
  #totSnow -> totQ
  'totSnow-totQ' = A_snow[8,3,], 
  #totSnow -> S2S_SH
  'totSnow-S2S_SH' = A_snow[8,4,], 
  #totSnow -> S2S_DP
  'totSnow-S2S_DP' = A_snow[8,5,],
  #totSnow -> S2N_SH
  'totSnow-S2N_SH' = A_snow[8,6,],
  #totSnow -> S2N_DP
  'totSnow-S2N_DP' = A_snow[8,7,],
  'lag' = seq(1, lags)) %>%
  melt(id.vars = 'lag')
```

```{r}
#Plot
snowHeatmap = ggplot(snow_plotting, aes(lag, variable)) +
  geom_tile(aes(fill = value), color = 'lightgray', lwd = 0.5, linetype = 1) +
  geom_text(aes(label = round(value, 2)), size = 3, color ='white') +
  scale_fill_gradient("Transfer Entropy", low = "lightblue", high = "deepskyblue4", na.value = 'white')+
  theme(panel.background = element_blank()) + 
  xlab("Time Lag [months]") + 
  ylab(" ")

save_plot(paste0(fig_save, 'snowHeatmap.pdf'), snowHeatmap, base_height = 5, base_asp = 2)
save_plot(paste0(fig_save, 'snowHeatmap.jpeg'), snowHeatmap, base_height = 5, base_asp = 2)
```

## Seasonal Timeseries Breakdown

In order to determine the separate influences of fall vs. winter vs. spring effects we are going to try separating all of the timeseries out into 'dormant', 'snowmelt', and 'growing seasons with values during the respective seasons and 0s everywhere else to keep the data structure

Dormant - JAN through APR, OCT through JAN
Snowmelt - APR through JUL
Growing - JUL through OCT

```{r}
#Shift column order and remove columns
data_monthly_seasonalDecomp = data_monthly_snow_anomaly[, c(1, 4, 12, 3, 5, 6, 7, 8, 9, 10, 11)]

#Segment data by adding a season column and masking data
data_monthly_seasonalDecomp = data_monthly_seasonalDecomp %>%
  mutate(season = ifelse(month(month) > 9 | month(month) < 4, 'dormant', ifelse(month(month) < 10 & month(month) > 6, 'growing', 'melt'))) %>%
  rename_with(~str_c(., "_full"), meanWTE:S2N_DP) %>%
  mutate(across(meanWTE_full:S2N_DP_full, ~ ifelse(season == 'dormant', .x, 0), .names = "{sub('full', 'dormant', col)}")) %>%
  mutate(across(meanWTE_full:S2N_DP_full, ~ ifelse(season == 'melt', .x, 0), .names = "{sub('full', 'melt', col)}")) %>%
  mutate(across(meanWTE_full:S2N_DP_full, ~ ifelse(season == 'growing', .x, 0), .names = "{sub('full', 'growing', col)}")) %>%
  select(-c(meanWTE_full:S2N_DP_full, season))


colnames(data_monthly_seasonalDecomp)
```

```{r}
vars = c("meanQ", "totSnow", "meanWTE_dormant", "meanT_dormant", "totPrecip_dormant", "totQ_dormant", "S2S_SH_dormant", "S2S_DP_dormant",
         "S2N_SH_dormant", "S2N_DP_dormant", "meanWTE_melt", "meanT_melt", "totPrecip_melt", "totQ_melt", "S2S_SH_melt", "S2S_DP_melt", "S2N_SH_melt",
         "S2N_DP_melt", "meanWTE_growing", "meanT_growing", "totPrecip_growing", "totQ_growing", "S2S_SH_growing", "S2S_DP_growing", "S2N_SH_growing", "S2N_DP_growing")

A_te_seasonal = array(dim = c(length(vars), length(vars), lags))
A_crit_seasonal = array(dim = c(length(vars), length(vars), lags))

for(i in seq(1, length(vars))){
  for(j in seq(1, length(vars))){
    #Assign variables
    iv = vars[i]
    jv = vars[j]
    
    #Loop through lags
    for(l in seq(1, lags)){
      #Shift data
      shifted = lagTS(data_monthly_seasonalDecomp[iv], data_monthly_seasonalDecomp[jv], l = l)
      
      #Compute TE
      te = transfer_entropy(shifted[iv], shifted[jv], quiet = TRUE, seed = 12345)
      
      #Add to full te list
      A_te_seasonal[i, j, l] = te$coef[1,1]
      A_crit_seasonal[i, j, l] = mean(te$boot["dtexy",]) + 1.66*sd(te$boot["dtexy",])
    }
  }
}
```

```{r}
#Only significant values
maskSeasonal = A_te_seasonal > A_crit_seasonal
A_seasonal = replace(A_te_seasonal, !maskSeasonal, NA)
```


```{r}
#Try plotting by seasonal influence
#Dormant -> Dormant A_seasonal[3:10, 3:10,]
#Dormant -> Melt A_seasonal[3:10, 11:18,]
#Dormant -> Growing A_seasonal[3:10, 19:26,]
#Melt -> Melt A_seasonal[11:18, 11:18,]
#Melt -> Growing A_seasonal[11:18, 19:26,]
#Melt -> Dormant A_seasonal[11:18, 3:10,]
#Growing -> Growing A_seasonal[19:26, 19:26,]
#Growing -> Dormant A_seasonal[19:26, 3:10,]
#Growing -> Melt A_seasonal[19:26, 11:18,]

for(month1 in c('dormant', 'melt', 'growing')){
  #Set first range
  if(month1 == 'dormant'){
    range1 = 3:10
  }else if(month1 == 'melt'){
    range1 = 11:18
  }else{
    range1 = 19:26
  }
  
  for(month2 in c('Dormant', 'Melt', 'Growing')){
    #Set second range
    if(month2 == 'Dormant'){
      range2 = 3:10
    }else if(month2 == 'Melt'){
      range2 = 11:18
    }else{
      range2 = 19:26
    }
    
    #Subset
    subsetSeasons = A_seasonal[range1, range2,]
    
    #[1] "meanWTE", [2]"meanT", [3]"totPrecip",  [4]"totQ", [5] "S2S_SH", [6]"S2S_DP", [7]"S2N_SH", [8]"S2N_DP"
    subsetSeasons_plotting = data.frame(
      'totPrecip-meanWTE' = subsetSeasons[3,1,],
      'totPrecip-totQ' = subsetSeasons[3,4,], 
      'totPrecip-S2S_SH' = subsetSeasons[3,5,], 
      'totPrecip-S2S_DP' = subsetSeasons[3,6,],
      'totPrecip-S2N_SH' = subsetSeasons[3,7,],
      'totPrecip-S2N_DP' = subsetSeasons[3,8,],
      'meanT-meanWTE' = subsetSeasons[2,1,],
      'meanT-totQ' = subsetSeasons[2,4,],
      'meanT-S2S_SH' = subsetSeasons[2,5,],
      'meanT-S2S_DP' = subsetSeasons[2,6,],
      'meanT-S2N_SH' = subsetSeasons[2,7,],
      'meanT-S2N_DP' = subsetSeasons[2,8,],
      'S2S_SH-S2S_DP' =  subsetSeasons[5,6,],
      'S2N_SH-S2N_DP' =  subsetSeasons[7,8,],
      'meanWTE-totQ' = subsetSeasons[1,4,],
      'S2S_SH-totQ' = subsetSeasons[5,4,],
      'S2S_DP-totQ' = subsetSeasons[6,4,],
      'S2N_SH-totQ' = subsetSeasons[7,4,],
      'S2N_DP-totQ' = subsetSeasons[8,4,],
      'lag' = seq(1, lags)) %>%
      melt(id.vars = 'lag')
    
    #Plot
    subsetSeasons_heatmap = ggplot(subsetSeasons_plotting, aes(lag, variable)) +
      geom_tile(aes(fill = value), color = 'lightgray', lwd = 0.5, linetype = 1) +
      geom_text(aes(label = round(value, 2)), size = 3, color ='white') +
      scale_fill_gradient("Transfer Entropy", low = "lightblue", high = "deepskyblue4", na.value = 'white')+
      theme(panel.background = element_blank()) + 
      xlab("Time Lag [months]") + 
      ylab(" ") +
      ggtitle(paste(month1, "->", month2, "Seasons"))
    
    save_plot(paste0(fig_save, month1, month2, 'Heatmap.pdf'), subsetSeasons_heatmap, base_height = 5, base_asp = 2)
    save_plot(paste0(fig_save, month1, month2, 'Heatmap.jpeg'), subsetSeasons_heatmap, base_height = 5, base_asp = 2)
        
  }
}
```

### Plots by effect

```{r}
dormant_range = 3:10

for(month2 in c('Melt', 'Growing')){
  #Set second range
  if(month2 == 'Melt'){
    range2 = 11:18
    lags = seq(1,7)
  }else{
    range2 = 19:26
    lags = seq(3,10)
  }
    
  #Subset
  subsetSeasons = A_seasonal[dormant_range, range2,]
  
  #Temperature subset
  temp_dormantseason_plotting = data.frame(
      'meanT-meanWTE' = subsetSeasons[2,1,lags],
      'meanT-totQ' = subsetSeasons[2,4,lags],
      'meanT-S2S_SH' = subsetSeasons[2,5,lags],
      'meanT-S2S_DP' = subsetSeasons[2,6,lags],
      'meanT-S2N_SH' = subsetSeasons[2,7,lags],
      'meanT-S2N_DP' = subsetSeasons[2,8,lags],
      'lag' = lags) %>%
      melt(id.vars = 'lag')
  
  #Plot
  subsetSeasons_slicedheatmap_temp = ggplot(temp_dormantseason_plotting, aes(lag, variable)) +
    geom_tile(aes(fill = value, height = 1, width = 1), color = 'lightgray', lwd = 0.5, linetype = 1) +
    geom_text(aes(label = round(value, 2)), size = 3, color ='white') +
    scale_fill_gradient("Transfer Entropy", low = "lightblue", high = "deepskyblue4", na.value = 'white', 
                         limit = c(0, 0.25))+
    coord_fixed(ratio=1) +
    theme(panel.background = element_blank()) + 
    xlab("Time Lag [months]") + 
    ylab(" ") +
    ggtitle(paste("Dormant ->", month2, "Seasons")) 
    
  save_plot(paste0(fig_save, 'Dormant', month2, 'SlicedTemp_Heatmap.pdf'), subsetSeasons_slicedheatmap_temp)
  save_plot(paste0(fig_save, 'Dormant', month2, 'SlicedTemp_Heatmap.jpeg'), subsetSeasons_slicedheatmap_temp)
  
  #Precip Subset
  precip_dormantseason_plotting = data.frame(
      'totPrecip-meanWTE' = subsetSeasons[3,1,lags],
      'totPrecip-totQ' = subsetSeasons[3,4,lags], 
      'totPrecip-S2S_SH' = subsetSeasons[3,5,lags], 
      'totPrecip-S2S_DP' = subsetSeasons[3,6,lags],
      'totPrecip-S2N_SH' = subsetSeasons[3,7,lags],
      'totPrecip-S2N_DP' = subsetSeasons[3,8,lags],
      'lag' = lags) %>%
      melt(id.vars = 'lag')
  
  #Plot
  subsetSeasons_slicedheatmap_precip = ggplot(precip_dormantseason_plotting, aes(lag, variable)) +
    geom_tile(aes(fill = value, height = 1, width = 1), color = 'lightgray', lwd = 0.5, linetype = 1) +
    geom_text(aes(label = round(value, 2)), size = 3, color ='white') +
    scale_fill_gradient("Transfer Entropy", low = "lightblue", high = "deepskyblue4", na.value = 'white', 
                        limit = c(0, 0.25))+
    coord_fixed(ratio=1) +
    theme(panel.background = element_blank()) + 
    xlab("Time Lag [months]") + 
    ylab(" ") +
    ggtitle(paste("Dormant ->", month2, "Seasons"))
    
  save_plot(paste0(fig_save, 'Dormant', month2, 'SlicedPrecip_Heatmap.pdf'), subsetSeasons_slicedheatmap_precip)
  save_plot(paste0(fig_save, 'Dormant', month2, 'SlicedPrecip_Heatmap.jpeg'), subsetSeasons_slicedheatmap_precip)
    
  #Soils Subset
  soil_dormantseason_plotting = data.frame(
      'S2S_SH-S2S_DP' =  subsetSeasons[5,6,lags],
      'S2N_SH-S2N_DP' =  subsetSeasons[7,8,lags],
      'S2S_SH-totQ' = subsetSeasons[5,4,lags],
      'S2S_DP-totQ' = subsetSeasons[6,4,lags],
      'S2N_SH-totQ' = subsetSeasons[7,4,lags],
      'S2N_DP-totQ' = subsetSeasons[8,4,lags],
      'meanWTE-totQ' = subsetSeasons[1,4,lags],
      'lag' = lags) %>%
      melt(id.vars = 'lag')
  
  #Plot
  subsetSeasons_slicedheatmap_soil = ggplot(soil_dormantseason_plotting, aes(lag, variable)) +
    geom_tile(aes(fill = value, height = 1, width = 1), color = 'lightgray', lwd = 0.5, linetype = 1) +
    geom_text(aes(label = round(value, 2)), size = 3, color ='white') +
    scale_fill_gradient("Transfer Entropy", low = "lightblue", high = "deepskyblue4", na.value = 'white', 
                        limit = c(0, 0.25))+
    coord_fixed(ratio=1) +
    theme(panel.background = element_blank()) + 
    xlab("Time Lag [months]") + 
    ylab(" ") +
    ggtitle(paste("Dormant ->", month2, "Seasons"))
    
  save_plot(paste0(fig_save, 'Dormant', month2, 'SlicedSoil_Heatmap.pdf'), subsetSeasons_slicedheatmap_soil)
  save_plot(paste0(fig_save, 'Dormant', month2, 'SlicedSoil_Heatmap.jpeg'), subsetSeasons_slicedheatmap_soil)
         
}
```


```{r}
melt_range = 11:18

for(month2 in c('Dormant', 'Growing')){
  #Set second range
  if(month2 == 'Dormant'){
    range2 = 3:10
    lags = seq(4,10)
  }else{
    range2 = 19:26
    lags = seq(1,4)
  }
    
  #Subset
  subsetSeasons = A_seasonal[melt_range, range2,]
  #Temperature subset
  temp_meltseason_plotting = data.frame(
      'meanT-meanWTE' = subsetSeasons[2,1,lags],
      'meanT-totQ' = subsetSeasons[2,4,lags],
      'meanT-S2S_SH' = subsetSeasons[2,5,lags],
      'meanT-S2S_DP' = subsetSeasons[2,6,lags],
      'meanT-S2N_SH' = subsetSeasons[2,7,lags],
      'meanT-S2N_DP' = subsetSeasons[2,8,lags],
      'lag' = lags) %>%
      melt(id.vars = 'lag')
  
  #Plot
  subsetSeasons_slicedheatmap_temp = ggplot(temp_meltseason_plotting, aes(lag, variable)) +
    geom_tile(aes(fill = value, height = 1, width = 1), color = 'lightgray', lwd = 0.5, linetype = 1) +
    geom_text(aes(label = round(value, 2)), size = 3, color ='white') +
    scale_fill_gradient("Transfer Entropy", low = "lightblue", high = "deepskyblue4", na.value = 'white', 
                        limit = c(0, 0.25))+
    coord_fixed(ratio=1) +
    theme(panel.background = element_blank()) + 
    xlab("Time Lag [months]") + 
    ylab(" ") +
    ggtitle(paste("melt ->", month2, "Seasons"))
    
  save_plot(paste0(fig_save, 'melt', month2, 'SlicedTemp_Heatmap.pdf'), subsetSeasons_slicedheatmap_temp)
  save_plot(paste0(fig_save, 'melt', month2, 'SlicedTemp_Heatmap.jpeg'), subsetSeasons_slicedheatmap_temp)
  
  #Precip Subset
  Precip_meltseason_plotting = data.frame(
      'totPrecip-meanWTE' = subsetSeasons[3,1,lags],
      'totPrecip-totQ' = subsetSeasons[3,4,lags], 
      'totPrecip-S2S_SH' = subsetSeasons[3,5,lags], 
      'totPrecip-S2S_DP' = subsetSeasons[3,6,lags],
      'totPrecip-S2N_SH' = subsetSeasons[3,7,lags],
      'totPrecip-S2N_DP' = subsetSeasons[3,8,lags],
      'lag' = lags) %>%
      melt(id.vars = 'lag')
  
  #Plot
  subsetSeasons_slicedheatmap_precip = ggplot(Precip_meltseason_plotting, aes(lag, variable)) +
    geom_tile(aes(fill = value, height = 1, width = 1), color = 'lightgray', lwd = 0.5, linetype = 1) +
    geom_text(aes(label = round(value, 2)), size = 3, color ='white') +
    scale_fill_gradient("Transfer Entropy", low = "lightblue", high = "deepskyblue4", na.value = 'white', 
                        limit = c(0, 0.25))+
    coord_fixed(ratio=1) +
    theme(panel.background = element_blank()) + 
    xlab("Time Lag [months]") + 
    ylab(" ") +
    ggtitle(paste("melt ->", month2, "Seasons"))
    
  save_plot(paste0(fig_save, 'melt', month2, 'SlicedPrecip_Heatmap.pdf'), subsetSeasons_slicedheatmap_precip)
  save_plot(paste0(fig_save, 'melt', month2, 'SlicedPrecip_Heatmap.jpeg'), subsetSeasons_slicedheatmap_precip)
    
  #Soils Subset
  Soil_meltseason_plotting = data.frame(
      'S2S_SH-S2S_DP' =  subsetSeasons[5,6,lags],
      'S2N_SH-S2N_DP' =  subsetSeasons[7,8,lags],
      'S2S_SH-totQ' = subsetSeasons[5,4,lags],
      'S2S_DP-totQ' = subsetSeasons[6,4,lags],
      'S2N_SH-totQ' = subsetSeasons[7,4,lags],
      'S2N_DP-totQ' = subsetSeasons[8,4,lags],
      'meanWTE-totQ' = subsetSeasons[1,4,lags],
      'lag' = lags) %>%
      melt(id.vars = 'lag')
  
  #Plot
  subsetSeasons_slicedheatmap_soil = ggplot(Soil_meltseason_plotting, aes(lag, variable)) +
    geom_tile(aes(fill = value, height = 1, width = 1), color = 'lightgray', lwd = 0.5, linetype = 1) +
    geom_text(aes(label = round(value, 2)), size = 3, color ='white') +
    scale_fill_gradient("Transfer Entropy", low = "lightblue", high = "deepskyblue4", na.value = 'white', 
                        limit = c(0, 0.25))+
    coord_fixed(ratio=1) +
    theme(panel.background = element_blank()) + 
    xlab("Time Lag [months]") + 
    ylab(" ") +
    ggtitle(paste("melt ->", month2, "Seasons"))
    
  save_plot(paste0(fig_save, 'melt', month2, 'SlicedSoil_Heatmap.pdf'), subsetSeasons_slicedheatmap_soil)
  save_plot(paste0(fig_save, 'melt', month2, 'SlicedSoil_Heatmap.jpeg'), subsetSeasons_slicedheatmap_soil)
        
}
```



## Cross-check some high TE values with lag plots

```{r}
#Function to plot any correlation lag plot
plotLag = function(x_seasonal, y_seasonal, x_full, y_full, lag, xlabel, ylabel){
  #Lag timeseries (x stays the same, y gets shifted back the lag amount)
  shifted_seasonal = lagTS(x_seasonal, y_seasonal, l = lag)
  shifted_full = lagTS(x_full, y_full, l = lag)
  
  #Calc values
  lagMI = round(mutinformation(discretize(shifted_seasonal$shiftedX), discretize(shifted_seasonal$shiftedY)), 2)
  lagTE = transfer_entropy(shifted_seasonal$shiftedX, shifted_seasonal$shiftedY,
                           lx = lagValue, ly = lagValue, quiet = TRUE, seed = 12345)$coef[1,1]
  
  #Make zeros NaN
  #x[x == 0] = NA
  #y[y == 0] = NA

  #Plot
  plotLag = ggplot() + 
    #Whole timeseries
    geom_point(aes(x = shifted_full$shiftedX, y = shifted_full$shiftedY), color = 'lightblue') +
    #Just seasonal timeseries
    geom_point(aes(x = shifted_seasonal$shiftedX, y = shifted_seasonal$shiftedY), color = 'black') + 
    xlab(xlabel) + 
    ylab(ylabel) +
    ggtitle(TeX(sprintf("$MI$ = %0.2f, $TE$ = %0.2f", lagMI, lagTE))) + 
    theme(aspect.ratio = 0.7, 
          panel.background = element_blank())
  
  return(plotLag)
}
```

### Lag Plots
```{r}
#Growing to Melt Season 

#Growing Temp -> Melt Soil Moisture S2N SH
S2N_SH_l7 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_SH_melt, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,
        lag = 7, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Shallow Soil Moist')

S2N_SH_l8 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_SH_melt,
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,
        lag = 8, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Shallow Soil Moist')

S2N_SH_l9 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_SH_melt, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,
        lag = 9, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Shallow Soil Moist')

S2N_SH_l10 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_SH_melt, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,
        lag = 10, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Shallow Soil Moist')

#Growing Temp -> Melt Soil Moisture S2N DP
S2N_DP_l7 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_DP_melt, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP,
        lag = 7, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Deep Soil Moist')

S2N_DP_l8 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_DP_melt, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP,
        lag = 8, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Deep Soil Moist')

S2N_DP_l9 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_DP_melt, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP, 
        lag = 9, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Deep Soil Moist')

S2N_DP_l10 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_DP_melt, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP, 
        lag = 10, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Deep Soil Moist')


#Growing Temp -> Melt Soil Moisture S2S SH
S2S_SH_l7 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_SH_melt, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH, 
        lag = 7, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Shallow Soil Moist')

S2S_SH_l8 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_SH_melt, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH, 
        lag = 8, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Shallow Soil Moist')

S2S_SH_l9 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_SH_melt, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,  
        lag = 9, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Shallow Soil Moist')

S2S_SH_l10 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_SH_melt, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,  
        lag = 10, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Shallow Soil Moist')


#Growing Temp -> Melt Soil Moisture S2S DP
S2S_DP_l7 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_DP_melt, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP, 
        lag = 7, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Deep Soil Moist')

S2S_DP_l8 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_DP_melt, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP, 
        lag = 8, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Deep Soil Moist')

S2S_DP_l9 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_DP_melt, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP,  
        lag = 9, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Deep Soil Moist')

S2S_DP_l10 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_DP_melt, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP,  
        lag = 10, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Deep Soil Moist')


growing_melt_plots = plot_grid(S2N_SH_l7, S2N_SH_l8, S2N_SH_l9, S2N_SH_l10,
                               S2N_DP_l7, S2N_DP_l8, S2N_DP_l9, S2N_DP_l10,
                               S2S_SH_l7, S2S_SH_l8, S2S_SH_l9, S2S_SH_l10,
                               S2S_DP_l7, S2S_DP_l8, S2S_DP_l9, S2S_DP_l10,
          labels = c('Lag 7', 'Lag 8', 'Lag 9', 'Lag 10'), 
          align = 'hv', 
          nrow = 4, ncol = 4)

save_plot(paste0(fig_save, 'growingMelt_lagPlots.pdf'), growing_melt_plots, base_height = 12, base_asp = 1)
save_plot(paste0(fig_save, 'growingMelt_lagPlots.jpeg'), growing_melt_plots, base_height = 12, base_asp = 1)

growing_melt_plots
```

```{r}
#Growing to Dormant Season 

#Growing Temp -> Dormant Soil Moisture S2N SH
S2N_SH_l2 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_SH_dormant, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,
        lag = 2, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Shallow Soil Moist')

S2N_SH_l3 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_SH_dormant,
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,
        lag = 3, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Shallow Soil Moist')

S2N_SH_l4 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_SH_dormant, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,
        lag = 4, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Shallow Soil Moist')

S2N_SH_l5 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_SH_dormant, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,
        lag = 5, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Shallow Soil Moist')

#Growing Temp -> Melt Soil Moisture S2N DP
S2N_DP_l2 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_DP_dormant, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP,
        lag = 2, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Deep Soil Moist')

S2N_DP_l3 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_DP_dormant, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP,
        lag = 3, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Deep Soil Moist')

S2N_DP_l4 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_DP_dormant, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP, 
        lag = 4, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Deep Soil Moist')

S2N_DP_l5 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2N_DP_dormant, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP, 
        lag = 5, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Deep Soil Moist')


#Growing Temp -> Melt Soil Moisture S2S SH
S2S_SH_l2 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_SH_dormant, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH, 
        lag = 2, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Shallow Soil Moist')

S2S_SH_l3 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_SH_dormant, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH, 
        lag = 3, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Shallow Soil Moist')

S2S_SH_l4 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_SH_dormant, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,  
        lag = 4, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Shallow Soil Moist')

S2S_SH_l5 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_SH_dormant, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,  
        lag = 5, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Shallow Soil Moist')


#Growing Temp -> Melt Soil Moisture S2S DP
S2S_DP_l2 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_DP_dormant, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP, 
        lag = 2, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Deep Soil Moist')

S2S_DP_l3 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_DP_dormant, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP, 
        lag = 3, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Deep Soil Moist')

S2S_DP_l4 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_DP_dormant, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP,  
        lag = 4, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Deep Soil Moist')

S2S_DP_l5 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_growing, y_seasonal = data_monthly_seasonalDecomp$S2S_DP_dormant, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP,  
        lag = 5, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Deep Soil Moist')


growing_dormant_plots = plot_grid(S2N_SH_l2, S2N_SH_l3, S2N_SH_l4, S2N_SH_l5,
                               S2N_DP_l2, S2N_DP_l3, S2N_DP_l4, S2N_DP_l5,
                               S2S_SH_l2, S2S_SH_l3, S2S_SH_l4, S2S_SH_l5,
                               S2S_DP_l2, S2S_DP_l3, S2S_DP_l4, S2S_DP_l5,
          labels = c('Lag 2', 'Lag 3', 'Lag 4', 'Lag 5'), 
          align = 'hv', 
          nrow = 4, ncol = 4)

save_plot(paste0(fig_save, 'growingDormant_lagPlots.pdf'), growing_dormant_plots, base_height = 12, base_asp = 1)
save_plot(paste0(fig_save, 'growingDormant_lagPlots.jpeg'), growing_dormant_plots, base_height = 12, base_asp = 1)

growing_dormant_plots
```

```{r}
#Melt to Growing Season 

#Melt Temp -> Growing Soil Moisture S2N SH
S2N_SH_l1 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2N_SH_growing, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,
        lag = 1, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Shallow Soil Moist')

S2N_SH_l2 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2N_SH_growing, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,
        lag = 2, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Shallow Soil Moist')

S2N_SH_l3 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2N_SH_growing,
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,
        lag = 3, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Shallow Soil Moist')

S2N_SH_l4 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2N_SH_growing, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,
        lag = 4, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Shallow Soil Moist')


#Growing Temp -> Melt Soil Moisture S2N DP

S2N_DP_l1 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2N_DP_growing, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP, 
        lag = 1, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Deep Soil Moist')

S2N_DP_l2 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2N_DP_growing, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP,
        lag = 2, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Deep Soil Moist')

S2N_DP_l3 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2N_DP_growing, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP,
        lag = 3, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Deep Soil Moist')

S2N_DP_l4 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2N_DP_growing, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP, 
        lag = 4, 
        xlabel = 'Temperature [C]', ylabel = 'S2 North Deep Soil Moist')

#Growing Temp -> Melt Soil Moisture S2S SH

S2S_SH_l1 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2S_SH_growing, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,  
        lag = 1, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Shallow Soil Moist')

S2S_SH_l2 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2S_SH_growing, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH, 
        lag = 2, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Shallow Soil Moist')

S2S_SH_l3 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2S_SH_growing, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH, 
        lag = 3, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Shallow Soil Moist')

S2S_SH_l4 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2S_SH_growing, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_SH,  
        lag = 4, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Shallow Soil Moist')


#Growing Temp -> Melt Soil Moisture S2S DP

S2S_DP_l1 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2S_DP_growing, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP,  
        lag = 1, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Deep Soil Moist')

S2S_DP_l2 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2S_DP_growing, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP, 
        lag = 2, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Deep Soil Moist')

S2S_DP_l3 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2S_DP_growing, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP, 
        lag = 3, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Deep Soil Moist')

S2S_DP_l4 = plotLag(x_seasonal = data_monthly_seasonalDecomp$meanT_melt, y_seasonal = data_monthly_seasonalDecomp$S2S_DP_growing, 
                    x_full = data_monthly_snow_anomaly$meanT, y_full = data_monthly_snow_anomaly$S2N_DP,  
        lag = 4, 
        xlabel = 'Temperature [C]', ylabel = 'S2 South Deep Soil Moist')


melt_growing_plots = plot_grid(S2N_SH_l1, S2N_SH_l2, S2N_SH_l3, S2N_SH_l4,
                               S2N_DP_l1, S2N_DP_l2, S2N_DP_l3, S2N_DP_l4,
                               S2S_SH_l1, S2S_SH_l2, S2S_SH_l3, S2S_SH_l4,
                               S2S_DP_l1, S2S_DP_l2, S2S_DP_l3, S2S_DP_l4,
          labels = c('Lag 1', 'Lag 2', 'Lag 3', 'Lag 4'), 
          align = 'hv', 
          nrow = 4, ncol = 4)

save_plot(paste0(fig_save, 'meltGrowing_lagPlots.pdf'), melt_growing_plots, base_height = 12, base_asp = 1)
save_plot(paste0(fig_save, 'meltGrowing_lagPlots.jpeg'), melt_growing_plots, base_height = 12, base_asp = 1)

melt_growing_plots
```









## Seasonal Monthly Mutual Information

```{r}
data_monthly_nogaps = data_monthly_nogaps %>%
  rename(date = month) %>%
  mutate(mon = month(date)) %>%
  select(-c('meanPrecip', 'meanQ')) %>%
  relocate(c("totQ", "mon"))

head(data_monthly_nogaps)
```

```{r}
for(i in seq(0, 10)){
  par(mfrow = c(2, 4), 
      pty = "s")
  
  #Correlation plots
  for(c in seq(4, 10)){
    lagDat = lagTS(data_monthly_nogaps[, c], data_monthly_nogaps$totQ, i)
  
    plot(x = lagDat[, 1], y = lagDat[, 2], 
         xlab = colnames(data_monthly_nogaps)[c], 
         ylab = 'Total Monthly Streamflow')
  }
  
  mtext(paste0(i, " Month Time Lag"), side = 3, line = -2, outer = TRUE)

}
```

```{r}
nbins = 30 

calc_seasonalQ_contribution_noConditional = function(var, lag){
    temp = c()
    
    #Lag timeseries
    lagDat = lagTS(data_monthly_nogaps[, var], data_monthly_nogaps$totQ, lag)
        
    #Attach monthly values
    lagDat = cbind(lagDat, month = data_monthly_nogaps$mon[0:(length(data_monthly_nogaps$mon)-lag)])
        
    for(i in seq(1, 12)){
        #filter
        lagDat_monthly = lagDat %>% filter(month == i)  

        #calculate mutual information
        temp = append(temp, natstobits(condinformation(X = discretize(lagDat_monthly$shiftedX, nbins = nbins),
                                          Y = discretize(lagDat_monthly$shiftedY, nbins = nbins))))
    }
    
    return(temp)
}

calc_seasonalQ_contribution_Conditional = function(var, lag){
    temp = c()
    
    #Lag timeseries
    lagDat = lagTS(data_monthly_nogaps[, var], data_monthly_nogaps$totQ, lag)
    
    #Lag autocorrelation
    lagY = lagTS(data_monthly_nogaps$totQ, data_monthly_nogaps$totQ, lag-1)
        
    #Attach monthly values
    lagDat = cbind(lagDat, month = data_monthly_nogaps$mon[0:(length(data_monthly_nogaps$mon)-lag)],
                   z = lagY$shiftedY[0:(length(lagY$shiftedY) - 1)])
    
    for(i in seq(1, 12)){
        #filter
        lagDat_monthly = lagDat %>% filter(month == i)  

        #calculate mutual information
        temp = append(temp, natstobits(condinformation(X = discretize(lagDat_monthly$shiftedX, nbins = nbins),
                                          Y = discretize(lagDat_monthly$shiftedY, nbins = nbins), 
                                          S = discretize(lagDat_monthly$z, nbins = nbins))))
    }
    
    return(temp)
}


```

```{r}
vars = c('meanT', 'totPrecip', 'meanWTE', 'S2S_SH', 'S2S_DP', 'S2N_SH', 'S2N_DP')

#Pure Mutual Information, no conditional
for(lag in seq(1, 6)){
  monthly_MI_data = data.frame(matrix(ncol = 0, nrow = 12))
  
  for(v in vars){
    monthly_MI_data[v] = calc_seasonalQ_contribution_noConditional(v, lag)
  }
  
  #Plot stacked time series
  monthly_MI_data = monthly_MI_data %>% 
    mutate(month = c(1:12)) %>%
    gather(variable, value, vars)
  
  monthlyplot = ggplot(data = monthly_MI_data, aes(x = month, y = value, fill = variable)) +
    geom_area() +
    scale_fill_brewer(palette = "BrBG") + 
    ylim(0,4) +
    xlim(1,12) +
    xlab('Month') + 
    ylab('Mutual Information') +
    ggtitle(paste0('Monthly Mutual Information, t = ', lag, ', l = none')) +
    theme(panel.background = element_blank()) + 
    scale_x_continuous(n.breaks=12)
  print(monthlyplot)
}
```

```{r}
buff = 0.2

#Time series based plots
#Transfer Entropy, i.e. Conditional Mutual Information
for(lag in seq(1, 6)){
  monthly_MI_data = data.frame(matrix(ncol = 0, nrow = 12))
  
  for(v in vars){
    monthly_MI_data[v] = calc_seasonalQ_contribution_Conditional(v, lag)
  }
  
  #Plot stacked time series (plus shifted data)
  x  = seq(1:12)
  #months = c(x[(lag+1):length(x)],x[1:(lag+1)-1])
  months = c(x[(length(x)-lag+1):length(x)], x[1:(length(x)-lag)])
  monthly_MI_data = monthly_MI_data %>% 
    mutate(month = months) %>%
    gather(variable, value, vars)
  
  monthlyplot = ggplot(data = monthly_MI_data, aes(x = month, y = value, fill = variable)) +
    #Label Seasons first
    #4, (4-lag)%%12
    #7, (7-lag)%%12
    #10, (10-lag)%%12
    geom_vline(xintercept = 4, linetype = "longdash", color = 'grey') +
    geom_text(aes(x = 4+buff, label="Melt Season", y=4), colour="grey", hjust = 'right', angle=90, size = 3) +
    geom_vline(xintercept = 7, linetype = "longdash", color = 'grey') +
    geom_text(aes(x = 7+buff, label="Growing Season", y=4), colour="grey", hjust = 'right', angle=90, size = 3) +
    geom_vline(xintercept = 10, linetype = "longdash", color = 'grey') +
    geom_text(aes(x = 10+buff, label="Snow Season", y=4), colour="grey", hjust = 'right', angle=90, size = 3) +
    #Plot
    geom_area() +
    scale_fill_brewer(palette = "BrBG") + 
    xlim(1,12) +
    ylim(0, 4) + 
    xlab('Month') + 
    ylab('Conditional Mutual Information') +
    theme(legend.position = 'bottom',
          panel.background = element_blank()) + 
    scale_x_continuous(n.breaks=12) 
  
  streamplot = ggplot(data = data_clipped, aes(x = yday(day), y = qInterval)) +
    stat_summary(fun = mean, geom = 'smooth', color = 'grey') + 
    ylim(0, 0.002) +
    xlim(0, 365) +
    xlab('Day of Year') + 
    ylab('Streamflow (m)') +
    ggtitle(paste0('Monthly Conditional Information, t = ', lag, ', l = 1')) +
    theme(panel.background = element_blank()) 
    
  fullplot = plot_grid(streamplot, monthlyplot, 
            ncol = 1,
            axis = 'l',
            align = 'v',
            rel_heights = c(2,4))
  
  save_plot(paste0(fig_save, 'monthlyTimeseries_MI_Lag', lag, '.pdf'), fullplot, base_height = 5)
  save_plot(paste0(fig_save, 'monthlyTimeseries_MI_Lag', lag, '.jpeg'), fullplot, base_height = 5)

  print(fullplot)
  
}
```

```{r}
#Variable based plots
#Transfer Entropy, i.e. Conditional Mutual Information
for(v in vars){
  monthly_MI_var_data = data.frame(matrix(ncol = 0, nrow = 12))
  
  for(lag in seq(1, 6)){
    temp = calc_seasonalQ_contribution_Conditional(v, lag)
    #time shift the MI values
    monthly_MI_var_data[lag] = c(temp[(length(temp)-lag+1):length(temp)], temp[1:(length(temp)-lag)])
  }
  
  #Plot stacked time series (plus shifted data)
  x  = seq(1:12)
  monthly_MI_var_data = monthly_MI_var_data %>% 
    mutate(month = x) %>%
    gather(variable, value, seq(1,6))
  
  monthlyplot = ggplot(data = monthly_MI_var_data, aes(x = month, y = value, fill = variable)) +
    #Label Seasons first
    geom_vline(xintercept = 4, linetype = "longdash", color = 'grey') +
    geom_text(aes(x = 4+buff, label="Melt Season", y=4), colour="grey", hjust = 'right', angle=90, size = 3) +
    geom_vline(xintercept = 7, linetype = "longdash", color = 'grey') +
    geom_text(aes(x = 7+buff, label="Growing Season", y=4), colour="grey", hjust = 'right', angle=90, size = 3) +
    geom_vline(xintercept = 10, linetype = "longdash", color = 'grey') +
    geom_text(aes(x = 10+buff, label="Snow Season", y=4), colour="grey", hjust = 'right', angle=90, size = 3) +
    #Plot
    geom_area() +
    scale_fill_brewer(palette = "PuBuGn") + 
    xlim(1,12) +
    ylim(0, 4) + 
    xlab('Month') + 
    ylab('Conditional Mutual Information') +
    ggtitle(paste0('Lagged Streamflow Contributions from ', v)) +
    theme(legend.position = 'bottom',
          panel.background = element_blank()) + 
    scale_x_continuous(n.breaks=12) 
  
  print(monthlyplot)
}
```

### Vectorized version

```{r}
#Prep daily data
#group by and summarize
data_means = data %>%
   group_by(day) %>%
   select(c(day, month, South_PCP, WTE, qInterval, MEANC)) %>%
   summarize_all(mean, na.rm = TRUE) %>%
   rename(meanPrecip = South_PCP, meanWTE = WTE, meanQ = qInterval, meanT = MEANC)

data_totals = data %>%
   select(c(day, month, South_PCP, qInterval)) %>%
   rename(totPrecip = South_PCP, totQ = qInterval)

#Currently grouping all soil data into north and south, deep and shallow resevoirs but will come back and separate these out later
data_soils = data %>%
  mutate(S2S_SH = rowMeans(select(data, c(S2S_UP_SH, S2S_MI_SH, S2S_LO_SH)), na.rm = TRUE)) %>%
  mutate(S2S_DP = rowMeans(select(data, c(S2S_UP_DP, S2S_MI_DP, S2S_LO_DP)), na.rm = TRUE)) %>%
  mutate(S2N_SH = rowMeans(select(data, c(S2N_UP_SH, S2N_MI_SH, S2N_LO_SH)), na.rm = TRUE)) %>%
  mutate(S2N_DP = rowMeans(select(data, c(S2N_UP_DP, S2N_MI_DP, S2N_LO_DP)), na.rm = TRUE)) %>%
  group_by(day) %>%
  select(c(day, month, S2S_SH, S2S_DP, S2N_SH, S2N_DP)) %>%
  summarize_all(mean, na.rm = TRUE)

#Merge all data together
data_daily = merge(data_means, data_totals, by = c('day', 'month'))
data_daily = merge(data_daily, data_soils, by = c('day', 'month'))
summary(data_daily)
```

#### Gapfill Streamflow Data

```{r}
#Streamflow model from precip and water tabe elevation

#Test if values below 421.67 are significantly different from zero
t.test(na.omit(data_daily %>% filter(meanWTE < 421.67))$totQ)

#model values above 421.67
data_daily['logTotQ'] = log(data_daily$totQ)
data_daily = data_daily %>% mutate_if(is.numeric, list(~na_if(., -Inf)))

modelQ = lm(logTotQ ~ meanWTE, data = na.omit(data_daily %>% filter(meanWTE > 421.67)))
summary(modelQ)
```

```{r}
modelQ_coef <- coef(modelQ)
x = seq(421.67, max(data_daily$meanWTE), by = 0.01)
y = exp(modelQ_coef[2]*x + modelQ_coef[1])
plot(x = na.omit(data_daily)$meanWTE, y = na.omit(data_daily)$totQ)
lines(x, y, col = "dodgerblue", lwd = 2)
legend("topleft", col = c("dodgerblue"), 
       legend = c("lm fit"), lwd = 2)

plot(modelQ)
```

```{r}
#Gapfill streamflow
data_daily$totQ <- ifelse(is.na(data_daily$totQ),
                          ifelse(data_daily$meanWTE < 421.67, 0, 
                                 exp(modelQ_coef[2]*data_daily$meanWTE + modelQ_coef[1])),
                          data_daily$totQ)
summary(data_daily)
```

#### Gapfill soil moisture data

```{r}
modelS2S_SH = lm(S2S_SH ~ meanWTE, data = na.omit(data_daily))
summary(modelS2S_SH)

par(mfrow = c(1, 2))
plot(x = na.omit(data_daily)$S2S_DP, y = na.omit(data_daily)$S2S_SH)
plot(x = na.omit(data_daily)$meanWTE, y = na.omit(data_daily)$S2S_SH)

par(mfrow=c(1,1))
plot(modelS2S_SH)

modelS2S_SH_coef <- coef(modelS2S_SH)
data_daily$S2S_SH <- ifelse(is.na(data_daily$S2S_SH),
                                 modelS2S_SH_coef[2]*data_daily$meanWTE +
                              #modelS2S_SH_coef[3]*data_daily$S2S_DP +
                              #modelS2S_SH_coef[4]*data_daily$S2S_DP*data_daily$meanWTE +
                              modelS2S_SH_coef[1],
                          data_daily$S2S_SH)
summary(data_daily$S2S_SH)
```

```{r}
modelS2S_DP = lm(S2S_DP ~ meanWTE, data = na.omit(data_daily))
summary(modelS2S_DP)

par(mfrow = c(1, 2))
plot(x = na.omit(data_daily)$totPrecip, y = na.omit(data_daily)$S2S_DP)
plot(x = na.omit(data_daily)$meanWTE, y = na.omit(data_daily)$S2S_DP)

par(mfrow=c(1,1))
plot(modelS2S_DP)

modelS2S_DP_coef <- coef(modelS2S_DP)
data_daily$S2S_DP <- ifelse(is.na(data_daily$S2S_DP),
                                 modelS2S_DP_coef[2]*data_daily$meanWTE +
                              #modelS2S_SH_coef[3]*data_daily$S2S_DP +
                              #modelS2S_SH_coef[4]*data_daily$S2S_DP*data_daily$meanWTE +
                              modelS2S_DP_coef[1],
                          data_daily$S2S_DP)
summary(data_daily$S2S_DP)
```

```{r}
modelS2N_SH = lm(S2N_SH ~ meanWTE, data = na.omit(data_daily))
summary(modelS2N_SH)

par(mfrow = c(1, 2))
plot(x = na.omit(data_daily)$S2N_DP, y = na.omit(data_daily)$S2N_SH)
plot(x = na.omit(data_daily)$meanWTE, y = na.omit(data_daily)$S2N_SH)

par(mfrow=c(1,1))
plot(modelS2N_SH)

modelS2N_SH_coef <- coef(modelS2N_SH)
data_daily$S2N_SH <- ifelse(is.na(data_daily$S2N_SH),
                                 modelS2N_SH_coef[2]*data_daily$meanWTE +
                              #modelS2S_SH_coef[3]*data_daily$S2S_DP +
                              #modelS2S_SH_coef[4]*data_daily$S2S_DP*data_daily$meanWTE +
                              modelS2N_SH_coef[1],
                          data_daily$S2N_SH)
summary(data_daily$S2N_SH)
```

```{r}
modelS2N_DP = lm(S2N_DP ~ meanWTE, data = na.omit(data_daily))
summary(modelS2N_DP)

par(mfrow = c(1, 2))
plot(x = na.omit(data_daily)$totPrecip, y = na.omit(data_daily)$S2N_DP)
plot(x = na.omit(data_daily)$meanWTE, y = na.omit(data_daily)$S2N_DP)

par(mfrow=c(1,1))
plot(modelS2N_DP)

modelS2N_DP_coef <- coef(modelS2N_DP)
data_daily$S2N_DP <- ifelse(is.na(data_daily$S2N_DP),
                                 modelS2N_DP_coef[2]*data_daily$meanWTE +
                              #modelS2S_SH_coef[3]*data_daily$S2S_DP +
                              #modelS2S_SH_coef[4]*data_daily$S2S_DP*data_daily$meanWTE +
                              modelS2N_DP_coef[1],
                          data_daily$S2N_DP)
summary(data_daily$S2N_DP)
```

```{r}
summary(data_daily)
```


#### Ensemble contributions


```{r}
nbins = 15
calc_seasonalQ_contribution_conditional_ensemble = function(var, lag){
  temp = c()
  
  #Lag timeseries
  #lagDat = lagTS(data_monthly_nogaps[, var], data_monthly_nogaps$totQ, lag)
  lagDat = lagTS(data_monthly_nogaps$date, data_monthly_nogaps$date, lag)
  
  #Lag autocorrelation
  #lagY = lagTS(data_monthly_nogaps$totQ, data_monthly_nogaps$totQ, lag-1)
  lagY = lagTS(data_monthly_nogaps$date, data_monthly_nogaps$date, lag-1)
  
          
  #Attach monthly values
  lagDat = cbind(lagDat,
                 z = lagY$shiftedY[0:(length(lagY$shiftedY) - 1)])
      
  for(i in seq(1, 12)){
    #filter
    lagDat_monthly = lagDat %>% filter(month(shiftedX) == i)  
    
    #pull daily values for the associated month
    X = data_daily %>%
        filter(data_daily$month %in% lagDat_monthly$shiftedX) %>%
        select(c(day, month, var)) %>%
        mutate(lagIndex = match(month, lagDat_monthly$shiftedX)) %>%
        mutate(dayOfMonth = as.integer(format(day, "%d"))) %>%
        select(-c(day, month))
    
    Y = data_daily %>%
        filter(data_daily$month %in% lagDat_monthly$shiftedY) %>%
        select(c(day, month, 'totQ')) %>%
        rename(totQ_Y = totQ) %>%
        mutate(lagIndex = match(month, lagDat_monthly$shiftedY)) %>%
        mutate(dayOfMonth = as.integer(format(day, "%d"))) %>%
        select(-c(day, month))
    
    Z = data_daily %>%
        filter(data_daily$month %in% lagDat_monthly$z) %>%
        select(c(day, month, 'totQ')) %>%
        rename(totQ_Z = totQ) %>%
        mutate(lagIndex = match(month, lagDat_monthly$z)) %>%
        mutate(dayOfMonth = as.integer(format(day, "%d"))) %>%
        select(-c(day, month))
    
    #merge
    lagDat_full = merge(X, merge(Y, Z, by = c('lagIndex', 'dayOfMonth')), by = c('lagIndex', 'dayOfMonth'), all = TRUE) %>%
      drop_na()
        
    #calculate mutual information
    temp = append(temp, natstobits(condinformation(X = discretize(lagDat_full[, var], nbins = nbins),
                                            Y = discretize(lagDat_full$totQ_Y, nbins = nbins), 
                                            S = discretize(lagDat_full$totQ_Z, nbins = nbins))))
  }
  
  return(temp)
}
```

```{r}
#Time series based plots with ENSEMBLE
#Transfer Entropy, i.e. Conditional Mutual Information
for(lag in seq(1, 6)){
  monthly_MI_data = data.frame(matrix(ncol = 0, nrow = 12))
  
  for(v in vars){
    monthly_MI_data[v] = calc_seasonalQ_contribution_conditional_ensemble(v, lag)
  }
  
  #Plot stacked time series (plus shifted data)
  x  = seq(1:12)
  #months = c(x[(lag+1):length(x)],x[1:(lag+1)-1])
  months = c(x[(length(x)-lag+1):length(x)], x[1:(length(x)-lag)])
  monthly_MI_data = monthly_MI_data %>% 
    mutate(month = months) %>%
    gather(variable, value, vars)
  
  monthlyplot = ggplot(data = monthly_MI_data, aes(x = month, y = value, fill = variable)) +
    #Label Seasons first
    #4, (4-lag)%%12
    #7, (7-lag)%%12
    #10, (10-lag)%%12
    geom_vline(xintercept = 4, linetype = "longdash", color = 'grey') +
    geom_text(aes(x = 4+buff, label="Melt Season", y=5), colour="grey", hjust = 'right', angle=90, size = 3) +
    geom_vline(xintercept = 7, linetype = "longdash", color = 'grey') +
    geom_text(aes(x = 7+buff, label="Growing Season", y=5), colour="grey", hjust = 'right', angle=90, size = 3) +
    geom_vline(xintercept = 10, linetype = "longdash", color = 'grey') +
    geom_text(aes(x = 10+buff, label="Snow Season", y=5), colour="grey", hjust = 'right', angle=90, size = 3) +
    #Plot
    geom_area() +
    scale_fill_brewer(palette = "BrBG") + 
    xlim(1,12) +
    ylim(0, 5) + 
    xlab('Month') + 
    ylab('Conditional Mutual Information') +
    theme(legend.position = 'bottom',
          panel.background = element_blank()) + 
    scale_x_continuous(n.breaks=12) 
  
  streamplot = ggplot(data = data_clipped, aes(x = yday(day), y = qInterval)) +
    stat_summary(fun = mean, geom = 'smooth', color = 'grey') + 
    ylim(0, 0.002) +
    xlim(0, 365) +
    xlab('Day of Year') + 
    ylab('Streamflow (m)') +
    ggtitle(paste0('Monthly Conditional Information, Ensemble, t = ', lag, ', l = 1')) +
    theme(panel.background = element_blank()) 
    
  fullplot = plot_grid(streamplot, monthlyplot, 
            ncol = 1,
            axis = 'l',
            align = 'v',
            rel_heights = c(2,4))
  
  save_plot(paste0(fig_save, 'monthlyTimeseries_MI_Ensemble_Lag', lag, '.pdf'), fullplot, base_height = 5)
  save_plot(paste0(fig_save, 'monthlyTimeseries_MI_Ensemble_Lag', lag, '.jpeg'), fullplot, base_height = 5)

  print(fullplot)
  
}
```

```{r}
#Variable based plots
#Transfer Entropy, i.e. Conditional Mutual Information
for(v in vars){
  monthly_MI_var_data = data.frame(matrix(ncol = 0, nrow = 12))
  
  for(lag in seq(1, 6)){
    temp = calc_seasonalQ_contribution_conditional_ensemble(v, lag)
    #time shift the MI values
    monthly_MI_var_data[lag] = c(temp[(length(temp)-lag+1):length(temp)], temp[1:(length(temp)-lag)])
  }
  
  #Plot stacked time series (plus shifted data)
  x  = seq(1:12)
  monthly_MI_var_data = monthly_MI_var_data %>% 
    mutate(month = x) %>%
    gather(variable, value, seq(1,6))
  
  monthlyplot = ggplot(data = monthly_MI_var_data, aes(x = month, y = value, fill = variable)) +
    #Label Seasons first
    geom_vline(xintercept = 4, linetype = "longdash", color = 'grey') +
    geom_text(aes(x = 4+buff, label="Melt Season", y=4), colour="grey", hjust = 'right', angle=90, size = 3) +
    geom_vline(xintercept = 7, linetype = "longdash", color = 'grey') +
    geom_text(aes(x = 7+buff, label="Growing Season", y=4), colour="grey", hjust = 'right', angle=90, size = 3) +
    geom_vline(xintercept = 10, linetype = "longdash", color = 'grey') +
    geom_text(aes(x = 10+buff, label="Snow Season", y=4), colour="grey", hjust = 'right', angle=90, size = 3) +
    #Plot
    geom_area() +
    scale_fill_brewer(palette = "PuBuGn") + 
    xlim(1,12) +
    ylim(0, 4) + 
    xlab('Month') + 
    ylab('Conditional Mutual Information, Ensemble') +
    ggtitle(paste0('Lagged Streamflow Contributions from ', v)) +
    theme(legend.position = 'bottom',
          panel.background = element_blank()) + 
    scale_x_continuous(n.breaks=12) 
  
  print(monthlyplot)
}
```





