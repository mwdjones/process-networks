---
title: "Transfer Entrop Flow Analysis"
author: "Mariel Jones"
date: "2024-08-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
fig_save = "./Figures/"
load_path = "./Data and Codes/Cleaned Data/"
```

```{r}
library(astsa)
library(dplyr)
library(xts)
library(lubridate)
library(RTransferEntropy)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(forecastML)
library(cowplot)
library(reshape2)
```

### Data Import from EDI

```{r}
## Precipitation
precipURL  <- "https://pasta.lternet.edu/package/data/eml/edi/849/5/4f7e0b3029833c26d64fda3d23037d1d" 
precipInfile <- tempfile()
try(download.file(precipURL,precipInfile,method="curl"))
if (is.na(file.size(precipInfile))) download.file(precipURL,precipInfile,method="auto")

precip <-read.csv(precipInfile , header=F, skip=1, sep = ",", 
               col.names=c("TIMESTAMP", "South_PCP", "South_Flag"),check.names=TRUE)
               
unlink(precipInfile)
tmp3TIMESTAMP<-as.POSIXct(precip$TIMESTAMP,format="%Y-%m-%d %H:%M:%S")
# Keep the new dates only if they all converted correctly
if(nrow(precip[precip$TIMESTAMP != "",]) == length(tmp3TIMESTAMP[!is.na(tmp3TIMESTAMP)])){precip$TIMESTAMP <- tmp3TIMESTAMP } else {print("Date conversion failed for precip$TIMESTAMP. Please inspect the data and do the date conversion yourself.")}                                 
if (class(precip$South_PCP)=="factor") precip$South_PCP <-as.numeric(levels(precip$South_PCP))[as.integer(precip$South_PCP) ]               
if (class(precip$South_PCP)=="character") precip$South_PCP <-as.numeric(precip$South_PCP)
if (class(precip$South_Flag)!="factor") precip$South_Flag<- as.factor(precip$South_Flag)
                
# Convert Missing Values to NA for non-dates
precip$South_PCP <- ifelse((trimws(as.character(precip$South_PCP))==trimws("NA")),NA,precip$South_PCP)         
## 10 minute soil moisture
smURL  <- "https://pasta.lternet.edu/package/data/eml/edi/989/3/e25d4f15276a3158af412758502a59b0" 
smInfile <- tempfile()
try(download.file(smURL,smInfile,method="curl"))
if (is.na(file.size(smInfile))) download.file(smURL,smInfile,method="auto")

sm <-read.csv(smInfile, header=F, skip=1, sep=",", 
              col.names=c("TIMESTAMP", "S2S_UP_SH", "S2S_UP_DP", "S2S_MI_SH", 
                          "S2S_MI_DP", "S2S_LO_SH", "S2S_LO_DP", "S2N_UP_SH",     
                          "S2N_UP_DP", "S2N_MI_SH", "S2N_MI_DP", "S2N_LO_SH",     
                          "S2N_LO_DP"), check.names=TRUE)
               
unlink(smInfile)
tmp2TIMESTAMP<-as.POSIXct(sm$TIMESTAMP,format="%Y-%m-%d %H:%M:%S")
# Keep the new dates only if they all converted correctly
if(nrow(sm[sm$TIMESTAMP != "",]) == length(tmp2TIMESTAMP[!is.na(tmp2TIMESTAMP)])){sm$TIMESTAMP <- tmp2TIMESTAMP } else {print("Date conversion failed for sm$TIMESTAMP. Please inspect the data and do the date conversion yourself.")}    

                                
## Bog well WTE
bogURL  <- "https://pasta.lternet.edu/package/data/eml/edi/562/3/671f15337a677da71852de506a8d9b05" 
bogInfile <- tempfile()
try(download.file(bogURL,bogInfile,method="curl"))
if (is.na(file.size(bogInfile))) download.file(bogURL,bogInfile,method="auto")

bog <-read.csv(bogInfile, header=F,skip=1, sep=",",
               col.names=c("PEATLAND", "DATE", "WTE", "FLAG"), check.names=TRUE)
               
unlink(bogInfile)
if (class(bog$PEATLAND)!="factor") bog$PEATLAND<- as.factor(bog$PEATLAND)                                   
tmp1DATE<-as.Date(bog$DATE,format="%Y-%m-%d")
# Keep the new dates only if they all converted correctly
if(nrow(bog[bog$DATE != "",]) == length(tmp1DATE[!is.na(tmp1DATE)])){bog$DATE <- tmp1DATE } else {print("Date conversion failed for bog$DATE. Please inspect the data and do the date conversion yourself.")}
if (class(bog$WTE)=="factor") bog$WTE <-as.numeric(levels(bog$WTE))[as.integer(bog$WTE) ]               
if (class(bog$WTE)=="character") bog$WTE <-as.numeric(bog$WTE)
if (class(bog$FLAG)!="factor") bog$FLAG<- as.factor(bog$FLAG)
                
# Convert Missing Values to NA for non-dates
bog$WTE <- ifelse((trimws(as.character(bog$WTE))==trimws("NA")),NA,bog$WTE)  

# Select just the S2 watershed
bog = bog %>%
  filter(PEATLAND == 'S2')



## Lagg transition well WTE
laggwellURL  <- "https://pasta.lternet.edu/package/data/eml/edi/1126/1/2532f551e6e5a97aee8f140fb5da8a74" 
laggwellInfile <- tempfile()
try(download.file(laggwellURL,laggwellInfile,method="curl"))
if (is.na(file.size(laggwellInfile))) download.file(laggwellURL,laggwellInfile,method="auto")

laggwell <-read.csv(laggwellInfile, header=F, skip=1, sep=",", quot='"' ,
                    col.names=c("DateTime", "LoggerLevel", "LoggerTemp", "BP",     
                                "Precip", "bogwell", "well_elev", "well_name",     
                                "watershed", "year"), check.names=TRUE)
               
unlink(laggwellInfile)
              
tmp1DateTime<-as.POSIXct(laggwell$DateTime,format="%Y-%m-%d %H:%M:%S" )
# Keep the new dates only if they all converted correctly
if(nrow(laggwell[laggwell$DateTime != "",]) == length(tmp1DateTime[!is.na(tmp1DateTime)])){laggwell$DateTime <- tmp1DateTime } else {print("Date conversion failed for laggwell$DateTime. Please inspect the data and do the date conversion yourself.")}


                                
## Streamflow
streamURL  <- "https://pasta.lternet.edu/package/data/eml/edi/573/1/2aca4b900546e80ed7dd409ff1ad9787" 
streamInfile <- tempfile()
try(download.file(streamURL,streamInfile,method="curl"))
if (is.na(file.size(streamInfile))) download.file(streamURL,streamInfile,method="auto")

stream <-read.csv(streamInfile, header=F, skip=1, sep=",",
                  col.names=c("Peatland", "DateTime", "Stage.ft", "Q.cfs", "q.mmh", "q.interval"),
                  check.names=TRUE)
               
unlink(streamInfile)
if (class(stream$Peatland)!="factor") stream$Peatland<- as.factor(stream$Peatland)                       
tmp1DateTime<-as.POSIXct(stream$DateTime,format="%Y-%m-%d %H:%M:%S")
# Keep the new dates only if they all converted correctly
if(nrow(stream[stream$DateTime != "",]) == length(tmp1DateTime[!is.na(tmp1DateTime)])){stream$DateTime <- tmp1DateTime } else {print("Date conversion failed for stream$DateTime. Please inspect the data and do the date conversion yourself.")} 


## Air Temperature
tempURL  <- "https://pasta.lternet.edu/package/data/eml/edi/859/4/e1e7792f8465017e133535bccbba4b6c" 
tempInfile <- tempfile()
try(download.file(tempURL,tempInfile,method="curl"))
if (is.na(file.size(tempInfile))) download.file(tempURL,tempInfile,method="auto")
temp <-read.csv(tempInfile, header=F, skip=1, sep=",", 
               col.names=c("TIMESTAMP", "Air_TempC_Avg", "RH",     
                    "Soil_TempC_Avg", "WS_Tot", "WindDir_D",     
                    "WindDir_SD", "PAR_Den_Avg", "Soil_VWC_Avg"),
               check.names=TRUE)
unlink(tempInfile)                      
tmp1DateTime<-as.POSIXct(temp$TIMESTAMP,format="%Y-%m-%d %H:%M:%S")
# Keep the new dates only if they all converted correctly
if(nrow(temp[temp$TIMESTAMP != "",]) == length(tmp1DateTime[!is.na(tmp1DateTime)])){temp$TIMESTAMP <- tmp1DateTime } else {print("Date conversion failed for stream$DateTime. Please inspect the data and do the date conversion yourself.")} 

## ET from Open ET
```

```{r}
#Data sets: stream (1962-2017), sm (2008-2023), precip (2011-2024), laggwell (2018-2020), bog (1961-2023), temp (2008-2024)

#Resample precip to daily timestep
#round dates down to week
precip$day <- floor_date(precip$TIMESTAMP, "day")

#find mean sales by week
precip_daily = data.frame(precip %>%
  group_by(day) %>%
  summarize(South_PCP = sum(South_PCP)))
```

```{r}
#Resample well data to daily timestep
#round dates down to week
laggwell$day <- floor_date(laggwell$DateTime, "day")

#find mean sales by week
laggwell_daily = data.frame(laggwell) %>%
  group_by(day, well_name) %>%
  summarize(well_elev = mean(well_elev))
```

```{r}
#Resample temperature to daily timestep
#round dates down to week
temp$day <- floor_date(temp$TIMESTAMP, "day")

#find mean sales by week
temp_daily = data.frame(temp) %>%
  group_by(day) %>%
  summarize(AirT_C = mean(Air_TempC_Avg))

head(temp_daily)
```

```{r}
#Melt the lagg data so there is a column per well
laggwell_melt = laggwell_daily %>%
  pivot_wider(names_from = 'well_name', values_from = 'well_elev')
head(laggwell_melt)
```

```{r}
#Resample soil moisture to daily timestep
#round dates down to week
sm$day <- floor_date(sm$TIMESTAMP, "day")

#find mean sales by week
sm_daily = data.frame(sm) %>%
  group_by(day) %>%
  summarise_all(mean) %>%
  select(-TIMESTAMP)

head(sm_daily)
```

```{r}
#Resample streamflow to daily timestep
#round dates down to week
stream$day <- floor_date(stream$DateTime, "day")

#find mean sales by week
stream_daily = data.frame(stream) %>%
  group_by(day) %>%
  summarize(qInterval = mean(q.interval)/10) 

head(stream_daily)
```

Merge data into one data frame for IT analysis

```{r}
#Merge into a dataframe by date and clip to full series
dat = merge(x = precip_daily, y = bog, by.x = "day", by.y = "DATE", all = TRUE)
dat = merge(dat, laggwell_melt, by = 'day', all = TRUE)
dat = merge(dat, sm_daily, by = 'day', how = 'outer', all = TRUE)
dat = merge(dat, stream_daily, by = 'day', how = 'outer', all = TRUE)
dat = merge(dat, temp_daily, by = 'day', how = 'outer', all = TRUE)
head(dat)
```


## Initial Plotting

```{r}
#Initial timeseries plots

#Precip
ggplot(data = dat, aes(x = day, y = South_PCP)) +
  geom_point(color = 'gray') +
  geom_line() +
  xlab('Date') + 
  ylab('Precipitation [cm]') + 
  theme(aspect.ratio = 0.3, 
        panel.background = element_blank())

#Bog WTE
ggplot(data = dat, aes(x = day, y = WTE)) + 
  geom_point(color = 'gray') + 
  geom_line() + 
  xlab('Date') + 
  ylab('Bog Water Table Elevation [m]') +
  theme(aspect.ratio = 0.3, 
        panel.background = element_blank())

#LAGG WTE
ggplot(data = dat) +
  geom_line(aes(x = day, y = KF42W), color = 'darkolivegreen1') + 
  geom_line(aes(x = day, y = KF43W), color = 'cadetblue1') + 
  geom_line(aes(x = day, y = KF45W), color = 'brown1') +
  geom_line(aes(x = day, y = S2S1), color = 'darkolivegreen') + 
  geom_line(aes(x = day, y = S2S2), color = 'cadetblue3') + 
  geom_line(aes(x = day, y = S2S3), color = 'brown') +
  xlab('Date') +
  ylab('Lagg Water Table Elevation [m]') + 
  theme(legend.position = 'none', 
        aspect.ratio = 0.3, 
        panel.background = element_blank())

#SOIL 
ggplot(data = dat) +
  geom_line(aes(x = day, y = S2S_UP_SH), color = 'darkolivegreen1') + 
  geom_line(aes(x = day, y = S2S_UP_DP), color = 'darkolivegreen1', linetype = 2) + 
  geom_line(aes(x = day, y = S2S_MI_SH), color = 'darkolivegreen3') +
  geom_line(aes(x = day, y = S2S_MI_DP), color = 'darkolivegreen3', linetype = 2) + 
  geom_line(aes(x = day, y = S2S_LO_SH), color = 'darkolivegreen') + 
  geom_line(aes(x = day, y = S2S_LO_DP), color = 'darkolivegreen', linetype = 2) +
  geom_line(aes(x = day, y = S2N_UP_SH), color = 'darkslategray1') + 
  geom_line(aes(x = day, y = S2N_UP_DP), color = 'darkslategray1', linetype = 2) + 
  geom_line(aes(x = day, y = S2N_MI_SH), color = 'darkslategray3') +
  geom_line(aes(x = day, y = S2N_MI_DP), color = 'darkslategray3', linetype = 2) + 
  geom_line(aes(x = day, y = S2N_LO_SH), color = 'darkslategray') + 
  geom_line(aes(x = day, y = S2N_LO_DP), color = 'darkslategray', linetype = 2) +
  xlab('Date') +
  ylab('Soil Moisture [m3/m3]') +
  theme(legend.position = 'none', 
        aspect.ratio = 0.3, 
        panel.background = element_blank()) 

#Streamflow
ggplot(data = dat, aes(x = day, y = qInterval)) +
  geom_point(color = 'gray') + 
  geom_line() + 
  xlab('Date') + 
  ylab('Streamflow [cm]') + 
  theme(aspect.ratio = 0.3,
        panel.background = element_blank())

```

## Clip to timescales for IT analysis

Leaving out the lagg water table levels, clip the data to the longest time length possible (~2012 - 2022)

```{r}
data_clipped = dat %>%
  select(-c('KF42W', 'KF43W', 'KF45W', 'S2S1', 'S2S2', 'S2S3', 'S6S1', 'S6S2', 'S6S3', 'S6N1', 'S6N2', 'S6N3'))

head(data_clipped)
```


```{r}
data = merge(data_clipped,
             data.frame(times = floor_date(seq(from = as.POSIXct('2011-02-03'), to = as.POSIXct('2017-02-28'), by = "day"), 'day')), 
             by.x = 'day', by.y = 'times', 
             all.y = TRUE)

head(data)
tail(data)
  
```
```{r}

#Precip
ggplot(data = data, aes(x = day, y = South_PCP)) +
  geom_point(color = 'gray') +
  geom_line() +
  xlab('Date') + 
  ylab('Precipitation [cm]') + 
  theme(aspect.ratio = 0.3, 
        panel.background = element_blank())

#Bog WTE
ggplot(data = data, aes(x = day, y = WTE)) + 
  geom_point(color = 'gray') + 
  geom_line() + 
  xlab('Date') + 
  ylab('Bog Water Table Elevation [m]') +
  theme(aspect.ratio = 0.3, 
        panel.background = element_blank())


#SOIL 
ggplot(data = data) +
  geom_line(aes(x = day, y = S2S_UP_SH), color = 'darkolivegreen1') + 
  geom_line(aes(x = day, y = S2S_UP_DP), color = 'darkolivegreen1', linetype = 2) + 
  geom_line(aes(x = day, y = S2S_MI_SH), color = 'darkolivegreen3') +
  geom_line(aes(x = day, y = S2S_MI_DP), color = 'darkolivegreen3', linetype = 2) + 
  geom_line(aes(x = day, y = S2S_LO_SH), color = 'darkolivegreen') + 
  geom_line(aes(x = day, y = S2S_LO_DP), color = 'darkolivegreen', linetype = 2) +
  geom_line(aes(x = day, y = S2N_UP_SH), color = 'darkslategray1') + 
  geom_line(aes(x = day, y = S2N_UP_DP), color = 'darkslategray1', linetype = 2) + 
  geom_line(aes(x = day, y = S2N_MI_SH), color = 'darkslategray3') +
  geom_line(aes(x = day, y = S2N_MI_DP), color = 'darkslategray3', linetype = 2) + 
  geom_line(aes(x = day, y = S2N_LO_SH), color = 'darkslategray') + 
  geom_line(aes(x = day, y = S2N_LO_DP), color = 'darkslategray', linetype = 2) +
  xlab('Date') +
  ylab('Soil Moisture [m3/m3]') +
  theme(legend.position = 'none', 
        aspect.ratio = 0.3, 
        panel.background = element_blank()) 

#Streamflow
ggplot(data = data, aes(x = day, y = qInterval)) +
  geom_point(color = 'gray') + 
  geom_line() + 
  xlab('Date') + 
  ylab('Streamflow [cm]') + 
  theme(aspect.ratio = 0.3,
        panel.background = element_blank())

#Temperature
ggplot(data = data, aes(x = day, y = AirT_C)) + 
  geom_point(color = 'gray') + 
  geom_line() + 
  xlab('Date') + 
  ylab('Air Temperature, [C]') + 
  theme(aspect.ratio = 0.3, 
        panel.background = element_blank())
```

## Aggregate to Monthly timescales

```{r}
#round dates down to week
data$month <- floor_date(data$day, "month")

#group by and summarize
data_means = data %>%
   group_by(month) %>%
   select(c(month, South_PCP, WTE, qInterval, AirT_C)) %>%
   summarize_all(mean, na.rm = TRUE) %>%
   rename(meanPrecip = South_PCP, meanWTE = WTE, meanQ = qInterval, meanT = AirT_C)

data_totals = data %>%
   group_by(month) %>%
   select(c(month, South_PCP, qInterval)) %>%
   summarize_all(sum, na.rm = TRUE) %>%
   rename(totPrecip = South_PCP, totQ = qInterval)

data_soils = data %>%
  mutate(S2S_SH = rowMeans(select(data, c(S2S_UP_SH, S2S_MI_SH, S2S_LO_SH)), na.rm = TRUE)) %>%
  mutate(S2S_DP = rowMeans(select(data, c(S2S_UP_DP, S2S_MI_DP, S2S_LO_DP)), na.rm = TRUE)) %>%
  mutate(S2N_SH = rowMeans(select(data, c(S2N_UP_SH, S2N_MI_SH, S2N_LO_SH)), na.rm = TRUE)) %>%
  mutate(S2N_DP = rowMeans(select(data, c(S2N_UP_DP, S2N_MI_DP, S2N_LO_DP)), na.rm = TRUE)) %>%
  group_by(month) %>%
  select(c(month, S2S_SH, S2S_DP, S2N_SH, S2N_DP)) %>%
  summarize_all(mean, na.rm = TRUE)
```

```{r}
#Merge all data together
data_monthly = merge(data_means, data_totals, by = 'month')
data_monthly = merge(data_monthly, data_soils, by = 'month')
summary(data_monthly)
```

## Monthly plots

```{r}
#Precip
p1 = ggplot(data = data_monthly) +
  geom_point(aes(x = month, y = meanPrecip, color = 'mean Precip')) +
  geom_line(aes(x = month, y = meanPrecip, color = 'mean Precip')) +
  geom_point(aes(x = month, y = totPrecip, color = 'total Precip')) +
  geom_line(aes(x = month, y = totPrecip, color = 'total Precip')) +
  geom_point(aes(x = month, y = meanT, color = 'mean Temp')) +
  geom_line(aes(x = month, y = meanT, color = 'mean Temp')) +
  xlab('Date') + 
  ylab('Precipitation [cm]') + 
  scale_color_manual(" ", values = c('gray', 'black', 'darkred')) + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

#Bog WTE
b1 = ggplot(data = data_monthly, aes(x = month, y = meanWTE)) + 
  geom_point(color = 'gray') + 
  geom_line(color = 'gray') + 
  xlab('Date') + 
  ylab('Bog WTE [m]') +
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())


#SOIL 
s1 = ggplot(data = data_monthly) +
  geom_line(aes(x = month, y = S2S_SH, color = 'S2S SH')) +
  geom_line(aes(x = month, y = S2S_DP, color = 'S2S DP'), linetype = 3) + 
  geom_line(aes(x = month, y = S2N_SH, color = 'S2N SH')) +
  geom_line(aes(x = month, y = S2N_DP, color = 'S2N DP'), linetype = 3) + 
  geom_point(aes(x = month, y = S2S_SH, color = 'S2S SH')) +
  geom_point(aes(x = month, y = S2S_DP, color = 'S2S DP')) + 
  geom_point(aes(x = month, y = S2N_SH, color = 'S2N SH')) +
  geom_point(aes(x = month, y = S2N_DP, color = 'S2N DP')) + 
  xlab('Date') +
  ylab('Soil Moisture [m3/m3]') +
  scale_color_manual(" ", values =  c("darkolivegreen3", "darkolivegreen3", "royalblue", "royalblue")) + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank()) 

#Streamflow
q1 = ggplot(data = data_monthly) +
  geom_point(aes(x = month, y = meanQ, color = 'mean Q')) +
  geom_line(aes(x = month, y = meanQ, color = 'mean Q')) +
  geom_point(aes(x = month, y = totQ, color = 'total Q')) +
  geom_line(aes(x = month, y = totQ, color = 'total Q')) +
  xlab('Date') + 
  ylab('Streamflow [cm]') + 
  scale_color_manual(" ", values = c('gray', 'black')) +
  theme(legend.position = 'top',
        aspect.ratio = 0.3,
        panel.background = element_blank())

timeseries = plot_grid(p1, b1, s1, q1,
          labels = c('A', 'B', 'C', 'D'),
          label_size = 12,
          align="hv")

save_plot(paste0(fig_save, 'monthlydata_timeseries.pdf'), timeseries, base_height = 5)
save_plot(paste0(fig_save, 'monthlydata_timeseries.jpeg'), timeseries, base_height = 5)
timeseries

```



## Gap filling of soil moisture data

```{r}
data_monthly_nogaps = data_monthly %>%
  mutate(S2S_DP = na.approx(S2S_DP)) %>%
  mutate(S2S_SH = na.approx(S2S_SH)) %>%
  mutate(S2N_DP = na.approx(S2N_DP)) %>%
  mutate(S2N_SH = na.approx(S2N_SH)) %>%
  mutate(meanT = na.approx(meanT))

summary(data_monthly_nogaps)
```

```{r}
ggplot(data = data_monthly_nogaps) +
  geom_line(aes(x = month, y = S2S_SH, color = 'S2S SH')) +
  geom_line(aes(x = month, y = S2S_DP, color = 'S2S DP'), linetype = 3) + 
  geom_line(aes(x = month, y = S2N_SH, color = 'S2N SH')) +
  geom_line(aes(x = month, y = S2N_DP, color = 'S2N DP'), linetype = 3) + 
  geom_point(aes(x = month, y = S2S_SH, color = 'S2S SH')) +
  geom_point(aes(x = month, y = S2S_DP, color = 'S2S DP')) + 
  geom_point(aes(x = month, y = S2N_SH, color = 'S2N SH')) +
  geom_point(aes(x = month, y = S2N_DP, color = 'S2N DP')) + 
  xlab('Date') +
  ylab('Soil Moisture [m3/m3]') +
  scale_color_manual(" ", values =  c("darkolivegreen3", "darkolivegreen3", "royalblue", "royalblue")) + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank()) 
```
```{r}
ggplot(data = data_monthly_nogaps) +
  geom_point(aes(x = month, y = meanPrecip, color = 'mean Precip')) +
  geom_line(aes(x = month, y = meanPrecip, color = 'mean Precip')) +
  geom_point(aes(x = month, y = totPrecip, color = 'total Precip')) +
  geom_line(aes(x = month, y = totPrecip, color = 'total Precip')) +
  geom_point(aes(x = month, y = meanT, color = 'mean Temp')) +
  geom_line(aes(x = month, y = meanT, color = 'mean Temp')) +
  xlab('Date') + 
  ylab('Precipitation [cm]') + 
  scale_color_manual(" ", values = c('gray', 'darkred', 'black')) + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())
```


## Information Theory Lagg Analysis

```{r}
## Assume one immediate history
lagValue = 1

## Shift time series
lagTS = function(x, y, l){
  #Shift
  shiftedX = lag(x, n = l)
  shiftedY = lag(y, n = 0)
  
  #Merge into data frame and clip to non-na
  dat = data.frame(shiftedX, shiftedY) %>%
    drop_na()
  
  return(dat)
}
```

```{r}
#Calculate shifted values
shifted = lagTS(data_monthly$totPrecip, data_monthly$meanWTE, l = 3)

#Test plot lagged time series
b2 = ggplot() + 
  geom_point(data = data_monthly, aes(x = month, y = meanWTE), color = 'lightblue') + 
  geom_line(data = data_monthly, aes(x = month, y = meanWTE), color = 'lightblue') +
  geom_point(data = shifted, aes(x = data_monthly$month[1:70], y = shiftedY), color = 'royalblue') + 
  geom_line(data = shifted, aes(x = data_monthly$month[1:70], y = shiftedY), color = 'royalblue') +
  xlab('Date') + 
  ylab('Mean Bog WTE [m]') +
  theme(aspect.ratio = 0.3, 
        panel.background = element_blank())

p2 = ggplot() + 
  geom_segment(data = data_monthly, aes(x = month, y = totPrecip, xend = month, yend = totPrecip-totPrecip), color = 'gray') + 
  geom_point(data = data_monthly, aes(x = month, y = totPrecip), color = 'gray') + 
  xlab('Date') + 
  ylab('Total Precip [cm]') +
  theme(aspect.ratio = 0.3, 
        panel.background = element_blank())

lagged_timeseries = plot_grid(b2, p2, 
          labels = c('A', 'B'), 
          align = 'hv', 
          ncol = 1)

save_plot(paste0(fig_save, 'sample_laggedtimeseries.pdf'), lagged_timeseries, base_height = 5)
save_plot(paste0(fig_save, 'sample_laggedtimeseries.jpeg'), lagged_timeseries, base_height = 5)
lagged_timeseries

```
```{r}
te = transfer_entropy(shifted$shiftedX, shifted$shiftedY, lx = lagValue, ly = lagValue)
te
```

Full test of a year of lags

```{r}
#Take out the non-useful columns
data_monthly_reduced = data_monthly_nogaps %>%
  select(-c(month, meanPrecip, meanQ, meanT))

#Collect combinations of variables
combinations_x = c("totPrecip", "totPrecip", "totPrecip", "totPrecip", "totPrecip", "totPrecip",
                   "meanWTE", 
                   "S2S_SH" , "S2S_SH", 
                   "S2N_SH" , "S2N_SH", 
                   "S2S_DP", 
                   "S2N_DP")
combinations_y = c("meanWTE", "totQ",  "S2S_SH", "S2S_DP", "S2N_SH", "S2N_DP", 
                   "totQ",
                   "S2S_DP", "totQ", 
                   "S2N_DP", "totQ", 
                   "totQ",
                   "totQ")
```


```{r}
#Lags to test
lags = 18
#Empty dataframe to contain te information
te_df = data.frame(matrix(ncol = 0, nrow = lags))


for(k in seq(1, length(combinations_x))){
    #Reset
    te_results_for = c()
    
    #Assign variables
    #significant TE
    i = combinations_x[k]
    j = combinations_y[k]
    
    #all te and tcrit
    allte = c()
    tecrit = c()
    
    #Loop through lags
    for(l in seq(1, lags)){
      #Shift data
      shifted = lagTS(data_monthly_reduced[i], data_monthly_reduced[j], l = l)
      
      #Compute TE
      te = transfer_entropy(shifted[i], shifted[j], quiet = TRUE, seed = 12345)
      
      #Add to full te list
      allte[l] = te$coef[1,1]
      tecrit[l] = mean(te$boot["dtexy",]) + 1.66*sd(te$boot["dtexy",])
      
      #If significant, add to other list, else na
      if(te$coef[1,4] < 0.05){
        te_results_for[l] = te$coef[1,1]
      }
      else{
        te_results_for[l] = NaN
      }
    }
    
    #Create and save TE plots
    lag_plot = ggplot() + 
            geom_point(aes(x = seq(1, lags), y = allte), color = 'royalblue') + 
            geom_line(aes(x = seq(1, lags), y = allte), color = 'royalblue') +
            geom_point(aes(x = seq(1, lags), y = tecrit), color = 'lightgray') + 
            geom_line(aes(x = seq(1, lags), y = tecrit), color = 'lightgray') +
            xlab('Lag') + 
            ylab('Transfer Entropy') +
            labs(subtitle = paste0(i, '->', j)) +
            theme(aspect.ratio = 0.3, 
                  panel.background = element_blank())
    save_plot(paste0(fig_save, 'lag plots/', i, '->', j, '-lagg-series.pdf'), lag_plot, base_height = 2, base_asp = 3)
    save_plot(paste0(fig_save, 'lag plots/', i, '->', j, '-lagg-series.jpeg'), lag_plot, base_height = 2, base_asp = 3)
              
    #Assign to dataframe
    te_df[paste0(i, '->', j)] = te_results_for
}
```

```{r}
head(te_df)
```

```{r}
#Heat map plot

#Melt data
te_df['lag'] = seq(1, lags)
te_df_melt = melt(te_df, id.vars = 'lag')

#Plot
lag_heatmap = ggplot(te_df_melt, aes(lag, variable)) +
  geom_tile(aes(fill = value), color = 'lightgray', lwd = 0.5, linetype = 1) +
  geom_text(aes(label = round(value, 2)), size = 3, color ='white') +
  scale_fill_gradient("Transfer Entropy", low = "lightblue", high = "deepskyblue4", na.value = 'white')+
  theme(panel.background = element_blank()) + 
  xlab("Time Lag [months]") + 
  ylab(" ")

save_plot(paste0(fig_save, 'laggedheatmap.pdf'), lag_heatmap, base_height = 5, base_asp = 2)
save_plot(paste0(fig_save, 'laggedheatmap.jpeg'), lag_heatmap, base_height = 5, base_asp = 2)
lag_heatmap
```


```{r}
#Full Adjacency matrix
vars = c("totPrecip", "meanWTE", "totQ",  "S2S_SH", "S2S_DP", "S2N_SH", "S2N_DP")

A_te = array(dim = c(length(vars), length(vars), lags))
A_crit = array(dim = c(length(vars), length(vars), lags))

for(i in seq(1, length(vars))){
  for(j in seq(1, length(vars))){
    #Assign variables
    iv = vars[i]
    jv = vars[j]
    
    #Loop through lags
    for(l in seq(1, lags)){
      #Shift data
      shifted = lagTS(data_monthly_reduced[iv], data_monthly_reduced[jv], l = l)
      
      #Compute TE
      te = transfer_entropy(shifted[iv], shifted[jv], quiet = TRUE, seed = 12345)
      
      #Add to full te list
      A_te[i, j, l] = te$coef[1,1]
      A_crit[i, j, l] = mean(te$boot["dtexy",]) + 1.66*sd(te$boot["dtexy",])
    }
  }
}

```

```{r}
#Watershed subsystem
A_watershed = A_te[-c(1, 3), -c(1, 3) , ]
A_south = A_te[c(4, 5), c(4, 5), ]
A_north = A_te[c(6, 7), c(6, 7), ]

#Watershed subsystems with only significant TE values
mask = A_te > A_crit
A_sig = replace(A_te, !mask, NA)
A_watershed_sig = A_sig[-c(1, 3), -c(1, 3) , ]
A_south_sig = A_sig[c(4, 5), c(4, 5), ]
A_north_sig = A_sig[c(6, 7), c(6, 7), ]
```


```{r}
notSig = ggplot() + 
  #Total information flow within the system
  geom_line(aes(x = seq(1, 18), y = colSums(A_te, dims = 2), color = 'Total')) + 
  geom_point(aes(x = seq(1, 18), y = colSums(A_te, dims = 2), color = 'Total')) + 
  #Total information exchange within the system (no P or Q)
  geom_line(aes(x = seq(1, 18), y = colSums(A_watershed, dims = 2), color = 'Watershed')) +
  geom_point(aes(x = seq(1, 18), y = colSums(A_watershed, dims = 2), color = 'Watershed')) +  
  #Total information exchange in the south hillslope
  geom_line(aes(x = seq(1, 18), y = colSums(A_south, dims = 2), color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = colSums(A_south, dims = 2), color = 'South Hillslope')) +
  #Total information exchange in the north hillslope
  geom_line(aes(x = seq(1, 18), y = colSums(A_north, dims = 2), color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = colSums(A_north, dims = 2), color = 'North Hillslope')) + 
  labs(x = 'Lag', y = 'Total System Information Transfer') + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue", "black", "darkred")) + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

Sig = ggplot() + 
  #Total information flow within the system
  geom_line(aes(x = seq(1, 18), y = colSums(A_sig, dims = 2, na.rm = TRUE), color = 'Total')) + 
  geom_point(aes(x = seq(1, 18), y = colSums(A_sig, dims = 2, na.rm = TRUE), color = 'Total')) + 
  #Total information exchange within the system (no P or Q)
  geom_line(aes(x = seq(1, 18), y = colSums(A_watershed_sig, dims = 2, na.rm = TRUE), color = 'Watershed')) +
  geom_point(aes(x = seq(1, 18), y = colSums(A_watershed_sig, dims = 2, na.rm = TRUE), color = 'Watershed')) +  
  #Total information exchange in the south hillslope
  geom_line(aes(x = seq(1, 18), y = colSums(A_south_sig, dims = 2, na.rm = TRUE), color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = colSums(A_south_sig, dims = 2, na.rm = TRUE), color = 'South Hillslope')) +
  #Total information exchange in the north hillslope
  geom_line(aes(x = seq(1, 18), y = colSums(A_north_sig, dims = 2, na.rm = TRUE), color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = colSums(A_north_sig, dims = 2, na.rm = TRUE), color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue", "black", "darkred")) + 
  labs(x = 'Lag', y = ' ') + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

plot_grid(notSig, Sig, 
          labels = c('A', 'B'), 
          align = 'hv', 
          ncol = 1)
  
```
There is more significant information flow between soil layers on the north hillslope than the south hillslope. 

The north hillslope seems to have more overall information transfer than the south hillslope, is there a signficant difference in the turnover of water on the north hillslope? This could be due to the fact that the north hillslope is south facing so there is higher ET, snow melt rates, etc. which leads to more turnover in the soil moisture
signatures.

Based on the data, the theory here is that higher soil moisture in the deeper layers on the south hillslope due to lower ET limit which simply encourages lateral runoff instead of infiltration into the deeper soil layers. If this were true, then the effect would be more pronounced at lower hillslopes and we would see input from shallow soil moisture at high elevation into shallow soil moisture at lower elevation.

```{r}
#Group soil moisture, un-lumped by hillslope and depth, data into monthly bins for separate analysis
sm_daily$month = floor_date(sm_daily$day, "month")
sm_monthly = sm_daily %>%
  group_by(month) %>%
  summarize_all(mean, na.rm = TRUE)

#Clip to same timescale as other data
sm_monthly = merge(sm_monthly,
             data.frame(times = floor_date(seq(from = as.POSIXct('2011-02-03'), to = as.POSIXct('2017-02-28'), by = "month"), 'month')), 
             by.x = 'month', by.y = 'times', 
             all.y = TRUE) %>%
  select(-c(day))

head(sm_monthly)
```

```{r}
sm_monthly_nogaps = sm_monthly %>%
   mutate(across(starts_with("S2"), ~ na.approx(.x, na.rm = FALSE))) 

summary(sm_monthly_nogaps)
```


```{r}
smUP = ggplot(data = sm_monthly_nogaps) +
  geom_line(aes(x = month, y = S2S_UP_SH, color = 'S2S SH')) +
  geom_line(aes(x = month, y = S2S_UP_DP, color = 'S2S DP'), linetype = 3) + 
  geom_line(aes(x = month, y = S2N_UP_SH, color = 'S2N SH')) +
  geom_line(aes(x = month, y = S2N_UP_DP, color = 'S2N DP'), linetype = 3) + 
  geom_point(aes(x = month, y = S2S_UP_SH, color = 'S2S SH')) +
  geom_point(aes(x = month, y = S2S_UP_DP, color = 'S2S DP')) + 
  geom_point(aes(x = month, y = S2N_UP_SH, color = 'S2N SH')) +
  geom_point(aes(x = month, y = S2N_UP_DP, color = 'S2N DP')) + 
  xlab('Date') +
  ylab('Soil Moisture [m3/m3]') +
  scale_color_manual(" ", values =  c("darkolivegreen3", "darkolivegreen3", "royalblue", "royalblue")) + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank()) 

smMI = ggplot(data = sm_monthly_nogaps) +
  geom_line(aes(x = month, y = S2S_MI_SH, color = 'S2S SH')) +
  geom_line(aes(x = month, y = S2S_MI_DP, color = 'S2S DP'), linetype = 3) + 
  geom_line(aes(x = month, y = S2N_MI_SH, color = 'S2N SH')) +
  geom_line(aes(x = month, y = S2N_MI_DP, color = 'S2N DP'), linetype = 3) + 
  geom_point(aes(x = month, y = S2S_MI_SH, color = 'S2S SH')) +
  geom_point(aes(x = month, y = S2S_MI_DP, color = 'S2S DP')) + 
  geom_point(aes(x = month, y = S2N_MI_SH, color = 'S2N SH')) +
  geom_point(aes(x = month, y = S2N_MI_DP, color = 'S2N DP')) + 
  xlab('Date') +
  ylab('Soil Moisture [m3/m3]') +
  scale_color_manual(" ", values =  c("darkolivegreen3", "darkolivegreen3", "royalblue", "royalblue")) + 
  theme(legend.position = 'None',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

smLO = ggplot(data = sm_monthly_nogaps) +
  geom_line(aes(x = month, y = S2S_LO_SH, color = 'S2S SH')) +
  geom_line(aes(x = month, y = S2S_LO_DP, color = 'S2S DP'), linetype = 3) + 
  geom_line(aes(x = month, y = S2N_LO_SH, color = 'S2N SH')) +
  geom_line(aes(x = month, y = S2N_LO_DP, color = 'S2N DP'), linetype = 3) + 
  geom_point(aes(x = month, y = S2S_LO_SH, color = 'S2S SH')) +
  geom_point(aes(x = month, y = S2S_LO_DP, color = 'S2S DP')) + 
  geom_point(aes(x = month, y = S2N_LO_SH, color = 'S2N SH')) +
  geom_point(aes(x = month, y = S2N_LO_DP, color = 'S2N DP')) + 
  xlab('Date') +
  ylab('Soil Moisture [m3/m3]') +
  scale_color_manual(" ", values =  c("darkolivegreen3", "darkolivegreen3", "royalblue", "royalblue")) + 
  theme(legend.position = 'None',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

sm_hillslopes = plot_grid(smUP, smMI, smLO, 
          labels = c('UP', 'MI', 'LO'), 
          align = 'hv', 
          ncol = 1)
save_plot(paste0(fig_save, 'sample_soilMhillslopes.pdf'), sm_hillslopes, base_height = 8)
save_plot(paste0(fig_save, 'sample_soilMhillslopes.jpeg'), sm_hillslopes, base_height = 8)
sm_hillslopes

```

```{r}
#South Hillslope Adjacency matrix
vars = c("S2S_UP_SH", "S2S_UP_DP", "S2S_MI_SH", "S2S_MI_DP", "S2S_LO_SH", "S2S_LO_DP")

A_southhill_te = array(dim = c(length(vars), length(vars), lags))
A_southhill_crit = array(dim = c(length(vars), length(vars), lags))

for(i in seq(1, length(vars))){
  for(j in seq(1, length(vars))){
    #Assign variables
    iv = vars[i]
    jv = vars[j]
    
    #Loop through lags
    for(l in seq(1, lags)){
      #Shift data
      shifted = lagTS(sm_monthly_nogaps[iv], sm_monthly_nogaps[jv], l = l)
      
      #Compute TE
      te = transfer_entropy(shifted[iv], shifted[jv], quiet = TRUE, seed = 12345)
      
      #Add to full te list
      A_southhill_te[i, j, l] = te$coef[1,1]
      A_southhill_crit[i, j, l] = mean(te$boot["dtexy",]) + 1.66*sd(te$boot["dtexy",])
    }
  }
}
```

```{r}
#North Hillslope Adjacency matrix
vars = c("S2N_UP_SH", "S2N_UP_DP", "S2N_MI_SH", "S2N_MI_DP", "S2N_LO_SH", "S2N_LO_DP")

A_northhill_te = array(dim = c(length(vars), length(vars), lags))
A_northhill_crit = array(dim = c(length(vars), length(vars), lags))

for(i in seq(1, length(vars))){
  for(j in seq(1, length(vars))){
    #Assign variables
    iv = vars[i]
    jv = vars[j]
    
    #Loop through lags
    for(l in seq(1, lags)){
      #Shift data
      shifted = lagTS(sm_monthly_nogaps[iv], sm_monthly_nogaps[jv], l = l)
      
      #Compute TE
      te = transfer_entropy(shifted[iv], shifted[jv], quiet = TRUE, seed = 12345)
      
      #Add to full te list
      A_northhill_te[i, j, l] = te$coef[1,1]
      A_northhill_crit[i, j, l] = mean(te$boot["dtexy",]) + 1.66*sd(te$boot["dtexy",])
    }
  }
}
```

```{r}
#Calculate out significant values
maskSouth = A_southhill_te > A_southhill_crit
A_southhill = replace(A_southhill_te, !maskSouth, NA)

maskNorth = A_northhill_te > A_northhill_crit
A_northhill = replace(A_northhill_te, !maskNorth, NA)
```

```{r}
#Reformatting for heatmap plotting
#[1]"UP_SH", [2]"UP_DP", [3]"MI_SH", [4]"MI_DP", [5]"LO_SH", [6]"LO_DP"
south_plotting = data.frame(
  #UP_SH -> UP_DP
  'UP_SH-UP_DP' = A_southhill[1,2,],
  #MI_SH -> MI_DP
  'MI_SH-MI_DP' = A_southhill[3,4,], 
  #LO_SH -> LO_DP
  'LO_SH-LO_DP' = A_southhill[5,6,], 
  #UP_SH -> MI_SH
  'UP_SH-MI_SH' = A_southhill[1,3,],
  #MI_SH -> LO_SH
  'MI_SH-LO_SH' = A_southhill[3,5,],
  #UP_DP -> MI_DP
  'UP_DP-MI_DP' = A_southhill[2,4,],
  #MI_DP -> LO_DP
  'MI_DP-LO_DP' = A_southhill[4,6,], 
  'lag' = seq(1, lags)) %>%
  melt(id.vars = 'lag')

north_plotting = data.frame(
  #UP_SH -> UP_DP
  'UP_SH-UP_DP' = A_northhill[1,2,],
  #MI_SH -> MI_DP
  'MI_SH-MI_DP' = A_northhill[3,4,], 
  #LO_SH -> LO_DP
  'LO_SH-LO_DP' = A_northhill[5,6,], 
  #UP_SH -> MI_SH
  'UP_SH-MI_SH' = A_northhill[1,3,],
  #MI_SH -> LO_SH
  'MI_SH-LO_SH' = A_northhill[3,5,],
  #UP_DP -> MI_DP
  'UP_DP-MI_DP' = A_northhill[2,4,],
  #MI_DP -> LO_DP
  'MI_DP-LO_DP' = A_northhill[4,6,],
  'lag' = seq(1, lags)) %>%
  melt(id.vars = 'lag')
```

```{r}
#Hillslope heatmaps
#Plot
south_heatmap = ggplot(south_plotting, aes(lag, variable)) +
  geom_tile(aes(fill = value), color = 'lightgray', lwd = 0.5, linetype = 1) +
  geom_text(aes(label = round(value, 2)), size = 3, color ='white') +
  scale_fill_gradient("Transfer Entropy", low = "lightblue", high = "deepskyblue4", na.value = 'white',
                      limits = c(0.03, 0.180))+
  theme(panel.background = element_blank()) + 
  xlab("Time Lag [months]") + 
  ylab(" ")

north_heatmap = ggplot(north_plotting, aes(lag, variable)) +
  geom_tile(aes(fill = value), color = 'lightgray', lwd = 0.5, linetype = 1) +
  geom_text(aes(label = round(value, 2)), size = 3, color ='white') +
  scale_fill_gradient("Transfer Entropy", low = "lightblue", high = "deepskyblue4", na.value = 'white',
                      limits = c(0.03, 0.180))+
  theme(panel.background = element_blank()) + 
  xlab("Time Lag [months]") + 
  ylab(" ")

hillslope_heatmaps = plot_grid(south_heatmap, north_heatmap, 
          labels = c('S', 'N'), 
          align = 'hv', 
          ncol = 1)

save_plot(paste0(fig_save, 'hillslopeheatmap.pdf'), hillslope_heatmaps, base_height = 5, base_asp = 2)
save_plot(paste0(fig_save, 'hillslopeheatmap.jpeg'), hillslope_heatmaps, base_height = 5, base_asp = 2)
hillslope_heatmaps
```

There continues to appear to be more information transfer in the north slope than the south slope but let's separate into line plots to see more clearly again. 

```{r}
#[1]"UP_SH", [2]"UP_DP", [3]"MI_SH", [4]"MI_DP", [5]"LO_SH", [6]"LO_DP"
#Fill Nans for plotting
A_southhill[is.na(A_southhill)] = 0
A_northhill[is.na(A_northhill)] = 0

#UP to MI, Shallow
upmi_shallow = ggplot() +  
  #south hillslope
  geom_line(aes(x = seq(1, 18), y = A_southhill[1, 3, ],
                color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_southhill[1, 3, ],
                color = 'South Hillslope')) + 
  #north hillslope
  geom_line(aes(x = seq(1, 18), y = A_northhill[1, 3,],
                color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_northhill[1, 3,],
                color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue")) + 
  labs(x = 'Lag', y = ' ', subtitle = 'Upland to Middle Hillslope, Shallow') + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

#MI to LO, Shallow
milo_shallow = ggplot() +  
  #south hillslope
  geom_line(aes(x = seq(1, 18), y = A_southhill[3, 5, ],
                color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_southhill[3, 5, ],
                color = 'South Hillslope')) + 
  #north hillslope
  geom_line(aes(x = seq(1, 18), y = A_northhill[3, 5, ],
                color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_northhill[3, 5, ],
                color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue")) + 
  labs(x = 'Lag', y = ' ', subtitle = 'Middle to Low Hillslope, Shallow') + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

#UP to MI, Deep
upmi_deep = ggplot() +  
  #south hillslope
  geom_line(aes(x = seq(1, 18), y = A_southhill[2, 4, ],
                color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_southhill[2, 4, ],
                color = 'South Hillslope')) + 
  #north hillslope
  geom_line(aes(x = seq(1, 18), y = A_northhill[2, 4, ],
                color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_northhill[2, 4, ],
                color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue")) + 
  labs(x = 'Lag', y = ' ', subtitle = 'Upland to Middle Hillslope, Deep') + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

#MI to LO, Deep
milo_deep = ggplot() +  
  #south hillslope
  geom_line(aes(x = seq(1, 18), y = A_southhill[4, 6, ],
                color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_southhill[4, 6, ],
                color = 'South Hillslope')) + 
  #north hillslope
  geom_line(aes(x = seq(1, 18), y = A_northhill[4, 6, ],
                color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_northhill[4, 6, ],
                color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue")) + 
  labs(x = 'Lag', y = ' ', subtitle = 'Middle to Low Hillslope, Deep') + 
  theme(legend.position = 'top',
        aspect.ratio = 0.3, 
        panel.background = element_blank())

hillslope_timeseries = plot_grid(upmi_shallow, milo_shallow, upmi_deep, milo_deep,
          labels = c('A', 'B', 'C', 'D'), 
          align = 'hv', 
          ncol = 2)
save_plot(paste0(fig_save, 'hillslopetimeseries.pdf'), hillslope_timeseries, base_height = 5, base_asp = 2)
save_plot(paste0(fig_save, 'hillslopetimeseries.jpeg'), hillslope_timeseries, base_height = 5, base_asp = 2)
hillslope_timeseries

```

```{r}
#[1]"UP_SH", [2]"UP_DP", [3]"MI_SH", [4]"MI_DP", [5]"LO_SH", [6]"LO_DP"
#UP 
up_infil = ggplot() +  
  #south hillslope
  geom_line(aes(x = seq(1, 18), y = A_southhill[1, 2, ],
                color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_southhill[1, 2, ],
                color = 'South Hillslope')) + 
  #north hillslope
  geom_line(aes(x = seq(1, 18), y = A_northhill[1, 2,],
                color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_northhill[1, 2,],
                color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue")) + 
  labs(x = 'Lag', y = ' ', subtitle = 'Upland Shallow to Deep') + 
  theme(legend.position = 'top',
        panel.background = element_blank())

#MI 
mi_infil = ggplot() +  
  #south hillslope
  geom_line(aes(x = seq(1, 18), y = A_southhill[3, 4, ],
                color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_southhill[3, 4, ],
                color = 'South Hillslope')) + 
  #north hillslope
  geom_line(aes(x = seq(1, 18), y = A_northhill[3, 4, ],
                color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_northhill[3, 4, ],
                color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue")) + 
  labs(x = 'Lag', y = ' ', subtitle = 'Middle Shallow to Deep') + 
  theme(legend.position = 'None',
        panel.background = element_blank())

#UP
lo_infil = ggplot() +  
  #south hillslope
  geom_line(aes(x = seq(1, 18), y = A_southhill[5, 6, ],
                color = 'South Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_southhill[5, 6, ],
                color = 'South Hillslope')) + 
  #north hillslope
  geom_line(aes(x = seq(1, 18), y = A_northhill[5, 6, ],
                color = 'North Hillslope')) + 
  geom_point(aes(x = seq(1, 18), y = A_northhill[5, 6, ],
                color = 'North Hillslope')) + 
  scale_color_manual(" ", values =  c("darkolivegreen3", "royalblue")) + 
  labs(x = 'Lag', y = ' ', subtitle = 'Lowland Shallow to Deep') + 
  theme(legend.position = 'None',
        panel.background = element_blank())

infiltration_timeseries = plot_grid(up_infil, mi_infil, lo_infil,
          labels = c('A', 'B', 'C'), 
          align = 'hv', 
          ncol = 1)
save_plot(paste0(fig_save, 'infiltrationtimeseries.pdf'), infiltration_timeseries, base_height = 6, base_asp = 0.8)
save_plot(paste0(fig_save, 'infiltrationtimeseries.jpeg'), infiltration_timeseries, base_height = 6, base_asp = 0.8)
infiltration_timeseries
```




